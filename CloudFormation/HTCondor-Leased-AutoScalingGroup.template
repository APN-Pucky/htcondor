{
	"AWSTemplateFormatVersion" : "2010-09-09",

	"Description" : "HTCondor CloudFormation for leased AutoScaling Groups.",

	"Metadata" : { },

	"Parameters" : {
		"Size" : {
			"Type" : "Number",
			"Default" : 10,
			"MinValue" : 1,
			"Description" : "How many instances do you want to add to your pool?",
			"ConstraintDescription" : "[Size] You must add at least one instance to your pool."
		},
		"CentralManager" : {
			"Type" : "String",
			"Description" : "The pool whose size you're increasing."
		},
		"LeaseDuration" : {
			"Type" : "Number",
			"Default" : 900,
			"MinValue" : 60,
			"Description" : "How long should the lease be (in seconds)?",
			"ConstraintDescription" : "[LeaseDuration] CloudWatch alarms must have periods than 60 seconds."
		},
		"SSHKeypairName" : {
			"Type" : "AWS::EC2::KeyPair::KeyName",
			"Description" : "Which SSH key pair should allow access to the instances?",
			"ConstraintDescription" : "[SSHKeypairName] SSH keypairs must already exist."
		}
	},

	"Mappings" : { },

	"Conditions" : { },

	"Resources" : {
		"LaunchConfiguration" : {
			"Type" : "AWS::AutoScaling::LaunchConfiguration",
			"Properties" : {
				"KeyName" : { "Ref" : "SSHKeypairName" },
				"ImageId" : "ami-0f4cfd64",
				"InstanceType" : "t1.micro",
				"SecurityGroups" : [ "sg-31eaa85c" ]
			}
		},

		"AutoScalingGroup" : {
			"Type" : "AWS::AutoScaling::AutoScalingGroup",
			"Properties" : {
				"AvailabilityZones" : { "Fn::GetAZs" : ""  },
				"MinSize" : 0,
				"DesiredCapacity" : { "Ref" : "Size" },
				"MaxSize" : { "Ref" : "Size" },
				"LaunchConfigurationName" : { "Ref" : "LaunchConfiguration" }
			}
		},

		"LeaseFunction" : {
			"Type" : "AWS::Lambda::Function",
			"Properties" : {
				"Code" : {
					"S3Bucket" : "htcondor-leased-autoscalinggroup",
					"S3Key" : "lambda-lease-1.jar"
				},
				"Description" : "Deletes the CloudFormation stack identified by the namespace of the triggering metric.",
				"Handler" : "org.HTCondor.Lease",
				"MemorySize" : 256,
				"Role" : "arn:aws:iam::844603466475:role/lambda_asg_execution",
				"Runtime" : "java8",
				"Timeout" : 30
			}
		},

		"Topic" : {
			"Type" : "AWS::SNS::Topic",
			"Properties" : {
				"Subscription" : [ {
					"Protocol" : "lambda",
					"Endpoint" : { "Fn::GetAtt" : [ "LeaseFunction", "Arn" ] }
				} ]
			}
		},

		"Alarm" : {
			"Type" : "AWS::CloudWatch::Alarm",
			"Properties" : {
				"AlarmDescription" : "Remove ASG if not alive.",
				"MetricName" : "Lease",
				"Namespace" : { "Fn::Join" :
					[ "/",
						[
							"HTCondor",
							"Leases",
							"CloudFormation",
							{ "Ref" : "AWS::StackName" }
						]
					]
				},
				"Statistic" : "Sum",
				"Period" : { "Ref" : "LeaseDuration" },
				"EvaluationPeriods" : 1,
				"Threshold" : 1,
				"ComparisonOperator" : "LessThanThreshold",
				"AlarmActions" : [ { "Ref" : "Topic" } ],
				"InsufficientDataActions" : [ { "Ref" : "Topic" } ]
			}
		},

		"PlumbingFunction" : {
			"Type" : "AWS::Lambda::Function",
			"Properties" : {
				"Code" : {
					"ZipFile" : { "Fn::Join" : [ "\n" , [
	"var response = require( 'cfn-response' );",
	"exports.handler = function( event, context ) {",
	"console.log( 'Received request:\\n', JSON.stringify( event ) );",
	"if( event.RequestType == 'Delete' ) {",
	"   // Delete subscription?",
	"   response.send( event, context, response.SUCCESS );",
	"   return;",
	"}",
	"var functionName = event.ResourceProperties.functionName;",
	"var sourceArn = event.ResourceProperties.sourceArn;",
	"var responseData = {};",
	"if( sourceArn ) {",
	"   var AWS = require( 'aws-sdk' );",
	"   var lambda = new AWS.Lambda();",
	"   var params = {  Action : 'lambda:*',",
	"                   FunctionName : functionName,",
	"                   Principal : 'sns.amazonaws.com',",
	"                   StatementId : 'HTCondor-Leased-AutoScalingGroup-Permissions',",
	"                   SourceArn : sourceArn",
	"   };",
	"   lambda.addPermission( params, function( error, data ) {",
	"       if( error ) {",
	"           console.log( error, error.stack );",
	"           responseData = { Error : 'addPermission() call failed' };",
	"           response.send( event, context, response.FAILURED, responseData );",
	"           return;",
	"       } else {",
	"           console.log( data );",
	"           response.send( event, context, response.SUCCESS );",
	"           return;",
	"       }",
	"   });",
	"} else {",
	"   responseData = { Error : 'sourceArn not specified' };",
	"   console.log( responseData.Error );",
	"   response.send( event, context, response.FAILED, responseData );",
	"}",
"};"
						]]}
					},
				"Description" : "Permits the given source to call the given function.  (A CloudFormation work-around.)",
				"Handler" : "index.handler",
				"Runtime" : "nodejs",
				"Role" : "arn:aws:iam::844603466475:role/lambda_asg_execution",
				"Timeout" : 30
			}
		},

		"Plumbing" : {
			"Type" : "Custom::Plumbing",
			"Properties" : {
				"ServiceToken" : { "Fn::GetAtt" : [ "PlumbingFunction", "Arn" ] },
				"functionName" : { "Ref" : "LeaseFunction" },
				"sourceArn" : { "Ref" : "Topic" }
			}
		},

		"ActivateAlarm" : {
			"Type" : "AWS::Lambda::Function",
			"Properties" : {
				"Code" : {
					"ZipFile" : { "Fn::Join" : [ "\n" , [
	"var response = require( 'cfn-response' );",
	"exports.handler = function( event, context ) {",
	"console.log( 'Received request:\\n', JSON.stringify( event ) );",
	"if( event.RequestType == 'Delete' ) {",
	"   response.send( event, context, response.SUCCESS );",
	"   return;",
	"}",
	"var namespace = event.ResourceProperties.Namespace;",
	"var responseData = {};",
	"if( namespace ) {",
	"   var AWS = require( 'aws-sdk' );",
	"   var cloudWatch = new AWS.CloudWatch();",
	"   var params = { MetricData : [ {",
	"           MetricName : 'Lease',",
	"           Value : 1",
	"   } ],",
	"       Namespace : namespace",
	" };",
	"   cloudWatch.putMetricData( params, function( error, data ) {",
	"       if( error ) {",
	"           console.log( error, error.stack );",
	"           responseData = { Error : 'putMetricData() call failed' };",
	"           response.send( event, context, response.FAILURED, responseData );",
	"           return;",
	"       } else {",
	"           console.log( data );",
	"           response.send( event, context, response.SUCCESS );",
	"           return;",
	"       }",
	"   });",
	"} else {",
	"   responseData = { Error : 'Namespace not specified' };",
	"   console.log( responseData.Error );",
	"   response.send( event, context, response.FAILED, responseData );",
	"}",
"};"
						]]}
				},
				"Description" : "Initializes the lease.",
				"Handler" : "index.handler",
				"Runtime" : "nodejs",
				"Role" : "arn:aws:iam::844603466475:role/lambda_asg_execution",
				"Timeout" : 30
			}
		},

		"ActiveAlarm" : {
			"Type" : "Custom::ActiveAlarm",
			"Properties" : {
				"ServiceToken" : { "Fn::GetAtt" : [ "ActivateAlarm", "Arn" ] },
				"comment" : "Copied Namespace from the alarm, because we can't GetAtt it.",
				"Namespace" : { "Fn::Join" :
					[ "/",
						[
							"HTCondor",
							"Leases",
							"CloudFormation",
							{ "Ref" : "AWS::StackName" }
						]
					] }
				}
			}
	},

	"Outputs" : {
		"AutoScalingGroupName" : {
			"Description" : "The name of the AutoScaling Group created by this template.",
			"Value" : { "Ref" : "AutoScalingGroup" }
		},

		"StackName" : {
			"Description" : "The name of this CloudFormation stack.",
			"Value" : { "Ref" : "AWS::StackName" }
		}
	}
}
