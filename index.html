<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>HTCondor Pool Monitoring</title>
  <style>
	body {
		font-family: "Helvetica Neue", Helvetica, sans-serif;
	}
  div.editmenu {
    position: absolute;
    right: 0;
    z-index: 20;
    background: #eee;
    visibility: hidden;
  }
  body:hover div.editmenu {
    visibility: visible;
  }
  div.editmenu a {
    text-decoration: none;
    padding: 2px;
  }
  div.editmenu a:hover {
    background: #aaa;
  }
  .vizchart {
	width: 100%;
	height: 400px;
	}
  #table1 .vizchart {
    text-align: center;
    height: auto;
  }
  #vizlog {
    white-space: pre;
  }
  .vizstatus {
    position: absolute;
    z-index: 4;
    width: 100%;
    text-align: center;
    padding-top: 1em;
  }
  #statussub {
    padding-left: 1em;
    color: #aaa;
  }
  .vizstep {
    margin-top: 2em;
    //display: none;
  }
  .vizstep .text {
    font-family: mono;
    font-weight: bold;
  }
  .vizstep .grid {
    margin-left: 3em;
    max-height: 10em;
    width: 50%;
    overflow: auto;
  }
  .dy-chart {
    border-bottom: 3px solid black;
  }
  .dy-chart-odd {
    background-color: #eee;
  }
  .dy-line {
    background-color: rgba(0,0,0,0.2);
    position: absolute;
    pointer-events: none;  /* don't capture double clicks, etc. */
  }
  .dy-xline {
    height: 100%;
    width: 3px;
    top: 0;
  }
  .dy-yline {
    height: 3px;
    width: 100%;
    left: 0;
  }
  .editlink {
	float: right;
	background: none;
	border: none;
	padding: 0;
	text-decoration: underline;
	color: blue;
	cursor: pointer;
	box-shadow: none;
	border-radius: 0;
	text-shadow: none;
  }

button {
	box-shadow: 1px 1px 0px 0px #CF866C inset;
	background: #D0451B linear-gradient(to bottom, #D0451B 5%, #BC3315 100%) repeat scroll 0% 0%;
	border-radius: 6px;
	border: 1px solid #942911;
	display: inline-block;
	cursor: pointer;
	color: #FFF;
	padding: 0.3em 1em;
	text-decoration: none;
	text-shadow: 0px 1px 0px #854629;
}
  </style>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dygraph/1.1.0/dygraph-combined.js"></script>
  <script src="https://www.google.com/jsapi"></script>
  <script>
  google.load('visualization', '1.0', {
    packages: ['table', 'corechart', 'treemap', 'annotatedtimeline']
  });
  </script>
  <script src="heatgrid.js"></script>
  <script src="render.js"></script>
</head>
<body>

<h1><img src="HTCondor_logo.png" style="display: inline-block;  height: 1.3em;" alt="HTCondor"> Pool Monitoring</h1>

<div class='editmenu'><button class="editlink" id='editlinkgraph1'>edit</button>
<div id="graph1editor" style="display:none;">
<textarea id='graph1text' cols="40" rows="10" wrap='off'>
</textarea>
<div>
<button id="rerendergraph1">Update Graph</button>
<button id="reloadgraph1">Reload Data</button>
<button id="reset_graph1">Reset</button>
</div>
</div>
</div>

<div id='graph1'>
<div class='vizstatus'>
  <div class='statustext'></div>
  <div class='statussub'></div>
</div>
<div class='vizraw'></div>
<div class='vizchart'></div>
</div>


<div class='editmenu'><button class="editlink" id='editlinktable1'>edit</button>
<div id="table1editor" style="display:none;">
<textarea id='table1text' cols="40" rows="10" wrap='off'>
</textarea>
<div>
<button id="rerendertable1">Update Table</button>
<button id="reloadtable1">Reload Data</button>
<button id="reset_table1">Reset</button>
</div>
</div>
</div>
<div id='table1'>
<div class='vizstatus'>
  <div class='statustext'></div>
  <div class='statussub'></div>
</div>
<div class='vizraw'></div>
<div class='vizchart'></div>
</div>


<h2>Log</h2>
  <div id='vizlog'></div>

<script>

function toggle_edit(btn, controls) {
	$(controls).toggle();
	if($(controls).is(":visible")) {
		$(btn).text("‚ùå")
	} else {
		$(btn).text("edit")
	}
}

$('#editlinkgraph1').click(function() { toggle_edit('#editlinkgraph1', '#graph1editor'); });
$('#editlinktable1').click(function() { toggle_edit('#editlinktable1', '#table1editor'); });

function load_arguments_to_form(key,form) {
	var args = afterquery.parseArgs(window.location.search);
	var val = args.get(key);
	$(form).val(val);
}

var urlTool = document.createElement('a');
function replace_search_arg(oldurl, newkey, newval) {
	urlTool.href = oldurl;
	var oldsearch = urlTool.search;
	var args = afterquery.parseArgs(oldsearch);
	var newsearch = "?";
	for(var argi in args.all) {
		var arg = args.all[argi];
		var key = arg[0];
		if(key.length && key != newkey) {
			var val = arg[1];
			newsearch += encodeURIComponent(key) + "=" + encodeURIComponent(val) + "&";	
		}
	}
	newsearch += encodeURIComponent(newkey) + "=" + encodeURIComponent(newval);	
	urlTool.search = newsearch;
	return urlTool.href;
}

function save_arguments_to_url() {
	var oldurl = window.location.href;

	var value = $('#graph1text').val().trim();
	var newurl = replace_search_arg(oldurl, 'graph1', value);

	value = $('#table1text').val().trim();
	newurl = replace_search_arg(newurl, 'table1', value);

	if(newurl != oldurl) {
		history.pushState(null, null, newurl);
	}
}

function read_arguments(source) {
  var out = [];
  var parts = $(source).val().trim().split('\n');
  for (var parti in parts) {
    var part = parts[parti];
    if (part) {
      var bits = afterquery.internal.trySplitOne(part, '=');
      if (bits) {
        out.push(encodeURIComponent(bits[0]) + '=' + encodeURIComponent(bits[1]));
      } else {
        out.push(encodeURIComponent(part));
      }
    }
  }
  return  '?' + out.join('&');
}



var data;
function load_and_render() {
	var callback_render_table = function() {
		setTimeout(function() {
			afterquery.render(read_arguments('#table1text'), data.value, null, 'table1', table_select_handler);
		}, 0);
	 };

	var callback_render_graph = function(){
		setTimeout(function() {
			afterquery.render(read_arguments('#graph1text'), data.value, callback_render_table, 'graph1');
			},0)
		};
	var args = read_arguments('#graph1text');
	data = afterquery.load(args, null, callback_render_graph, 'graph1');
}

function table_select_handler(evnt,table,data) {
	var selection = table.getSelection();
	if(selection) {
		var row = selection[0].row;
		var user = data.getValue(row, 0);
		var new_graph_args =
			"title=Machine State for " + user + "\n" +
			"filter=User==" + user + "\n" +
			"url=foo.json\n" +
			"order=State\n" +
			"pivot=Date;State;Cpus\n" +
			"chart=stacked\n";
		render_new_graph('#graph1text', 'graph1', new_graph_args);
	}
}

function render_new_graph(editid, graphid, args) {
	if(args && args.length) {
		$(editid).val(args);
	}
	afterquery.render(read_arguments(editid), data.value,null,graphid);
	save_arguments_to_url();
}

function default_graph_args() { 
return "title=Machine State\n" +
	"url=foo.json\n" +
	"order=State\n" +
	"pivot=Date;State;Cpus\n" +
	"chart=stacked";
}

function default_table_args() {
return "url=foo.json\n" +
	"order=Date,User\n" +
	"pivot=User;State;last(Cpus)";
}

window.onpopstate = function() {
	setTimeout(function(){
		load_arguments_to_form('graph1', '#graph1text');
		load_arguments_to_form('table1', '#table1text');
		load_and_render();
		},1);
}

$('#reloadgraph1').click(function() {
	load_and_render();
	save_arguments_to_url();
	});
$('#rerendergraph1').click(function() { render_new_graph('#graph1text', 'graph1'); });
$('#reset_graph1').click(function(){ render_new_graph('#graph1text', 'graph1', default_graph_args()); });

$('#reloadtable1').click(function() {
	load_and_render();
	save_arguments_to_url();
	});
$('#rerendertable1').click(function() { render_new_graph('#table1text', 'table1'); });
$('#reset_table1').click(function(){ render_new_graph('#table1text', 'table1', default_table_args()); });

$(document).ready( function() {
	if(!window.location.search) {

		$('#graph1text').val(default_graph_args());
		$('#table1text').val(default_table_args());
		save_arguments_to_url();
	}
	load_arguments_to_form('graph1', '#graph1text');
	load_arguments_to_form('table1', '#table1text');
	load_and_render();
}) ;

</script>

</body>
</html>
