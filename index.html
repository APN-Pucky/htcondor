<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>HTCondorView</title>
  <link rel="stylesheet" href="index.css" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dygraph/1.1.0/dygraph-combined.js"></script>
  <script src="https://www.google.com/jsapi"></script>
  <script>
  google.load('visualization', '1.0', {
    packages: ['table', 'corechart', 'treemap', 'annotatedtimeline']
  });
  </script>
  <script src="heatgrid.js"></script>
  <script src="render.js"></script>

<style>
.download-link {
font-size:80%;
text-align: center;
}
.tab-content {
	display: none;
}
.tab-content.current {
	display: inherit;
}

ul.radio-tabs {
	display: inline;
	margin: 0;
	padding: 0;
}

ul.radio-tabs li {
	display: inline-block;
}
ul.radio-tabs li input[type="radio"] {
	display: none;
}
ul.radio-tabs li label {
	display: block;
	border: 1px solid black;
	background: #ededed;
	padding: .1em .8em;
	cursor: pointer;
}
ul.radio-tabs li:first-child label {
	border-top-left-radius: .6em;
	border-bottom-left-radius: 0.6em;
}
ul.radio-tabs li:last-child label {
	border-top-right-radius: 0.6em;
	border-bottom-right-radius: 0.6em;
}
ul.radio-tabs li input[type="radio"]:checked + label {
	background: white;
	cursor: inherit;
}
</style>
</head>
<body>

<h1><img src="HTCondor_logo.png" style="display: inline-block;  height: 1.3em;" alt="HTCondor"> View</h1>

<div style="text-align: center">
<ul class="radio-tabs" id="data-source">
<li><input type="radio" name="data-source" id="data-source-user" value="submitters" checked> <label for="data-source-user">Users</label>
<li><input type="radio" name="data-source" id="data-source-machine" value="machines"> <label for="data-source-machine">Pool</label>
<li><input type="radio" name="data-source" id="data-source-custom" value="custom"> <label for="data-source-custom">Custom</label>
</ul>
<ul class="radio-tabs" id="data-duration">
<li><input type="radio" name="data-duration" id="data-duration-now" value="now"> <label for="data-duration-now">Now</label>
<li><input type="radio" name="data-duration" id="data-duration-day" value="day" checked> <label for="data-duration-day">Day</label>
<li><input type="radio" name="data-duration" id="data-duration-week" value="week"> <label for="data-duration-week">Week</label>
<li><input type="radio" name="data-duration" id="data-duration-month" value="month"> <label for="data-duration-month" checked>Month</label>
</ul>
</div>


<div id="tab-user" class="tab-content current">

<div class='editmenu'><button class="editlink" id='editlinkgraph1'>edit</button>
<div id="graph1editor" style="display:none;">
<textarea id='graph1text' cols="40" rows="10" wrap='off'>
</textarea>
<div>
<button id="rerendergraph1">Update Graph</button>
<button id="reloadgraph1">Reload Data</button>
</div>
</div>
<br><button onclick="alert('Not yet implemented')" class="editlink">full screen</button>
</div>

<div id='graph1'>
<div class='vizstatus'>
  <div class='statustext'></div>
  <div class='statussub'></div>
</div>
<div class='vizraw'></div>
<div class='vizchart'></div>
</div>


<div class="download-link"> <a onclick="alert('Not yet implemented');" href="#not-yet-implemented">Download this table</a> </div>
<div class='editmenu'><button class="editlink" id='editlinktable1'>edit</button>
<div id="table1editor" style="display:none;">
<textarea id='table1text' cols="40" rows="10" wrap='off'>
</textarea>
<div>
<button id="rerendertable1">Update Table</button>
<button id="reloadtable1">Reload Data</button>
</div>
</div>
</div>

<div id='table1'>
<div class='vizstatus'>
  <div class='statustext'></div>
  <div class='statussub'></div>
</div>
<div class='vizraw'></div>
<div class='vizchart'></div>
</div>

</div> <!-- #tab-user .tab-content -->

<div id="tab-machine" class="tab-content">
</div>

<div id="tab-custom" class="tab-content">
TODO Custom
</div>

<div id='vizlog'></div>

<script>

function toggle_edit(btn, controls) {
	$(controls).toggle();
	if($(controls).is(":visible")) {
		$(btn).text("‚ùå")
	} else {
		$(btn).text("edit")
	}
}

$('#editlinkgraph1').click(function() { toggle_edit('#editlinkgraph1', '#graph1editor'); });
$('#editlinktable1').click(function() { toggle_edit('#editlinktable1', '#table1editor'); });

function load_arguments_to_form(key,form) {
	var args = afterquery.parseArgs(window.location.search);
	var val = args.get(key);
	$(form).val(val);
}

var urlTool = document.createElement('a');
function replace_search_arg(oldurl, newkey, newval) {
	urlTool.href = oldurl;
	var oldsearch = urlTool.search;
	var args = afterquery.parseArgs(oldsearch);
	var newsearch = "?";
	for(var argi in args.all) {
		var arg = args.all[argi];
		var key = arg[0];
		if(key.length && key != newkey) {
			var val = arg[1];
			newsearch += encodeURIComponent(key) + "=" + encodeURIComponent(val) + "&";	
		}
	}
	newsearch += encodeURIComponent(newkey) + "=" + encodeURIComponent(newval);	
	urlTool.search = newsearch;
	return urlTool.href;
}

function save_arguments_to_url() {
	var oldurl = window.location.href;

	var value = $('#graph1text').val().trim();
	var newurl = replace_search_arg(oldurl, 'graph1', value);

	value = $('#table1text').val().trim();
	newurl = replace_search_arg(newurl, 'table1', value);

	if(newurl != oldurl) {
		history.pushState(null, null, newurl);
	}
}

function read_arguments(source) {
  var out = [];
  var parts = $(source).val().trim().split('\n');
  for (var parti in parts) {
    var part = parts[parti];
    if (part) {
      var bits = afterquery.internal.trySplitOne(part, '=');
      if (bits) {
        out.push(encodeURIComponent(bits[0]) + '=' + encodeURIComponent(bits[1]));
      } else {
        out.push(encodeURIComponent(part));
      }
    }
  }
  return  '?' + out.join('&');
}


var data_url;
var data;
function load_and_render() {
	var callback_render_table = function() {
		setTimeout(function() {
			var options = {
				select_handler: table_select_handler,
				num_pattern: '#,##0.0',
				disable_height: true
			};

			afterquery.render(read_arguments('#table1text'), data.value, null, 'table1', options);
		}, 0);
	 };

	var callback_render_graph = function(){
		setTimeout(function() {
			afterquery.render(read_arguments('#graph1text'), data.value, callback_render_table, 'graph1');
			},0)
		};
	var args = read_arguments('#graph1text');
	var newurl = afterquery.parseArgs(args).get('url');
	if(newurl == data_url) {
		callback_render_graph();
	} else {
		data_url = newurl;
		data = afterquery.load(args, null, callback_render_graph, 'graph1');
	}
}

function table_select_handler(evnt,table,data) {
	var selection = table.getSelection();
	if(selection) {
		var source = $('#data-source input[type="radio"]:checked').val()
		var duration = $('#data-duration input[type="radio"]:checked').val()
		if(source == "machines") {
			var row = selection[0].row;
			var arch = data.getValue(row, 0);
			var opsys = data.getValue(row, 1);
			var new_graph_args = machines_graph_args(arch,opsys);
			render_new_graph('#graph1text', 'graph1', new_graph_args);
		} else if(source =="submitters") {
			if(duration == 'now') {
				var row = selection[0].row;
				var user = data.getValue(row, 0);
				var new_graph_args = submitter_now_graph_args(user);
				render_new_graph('#graph1text', 'graph1', new_graph_args);
			} else {
				var row = selection[0].row;
				var user = data.getValue(row, 0);
				var new_graph_args = submitter_graph_args(user);
				render_new_graph('#graph1text', 'graph1', new_graph_args);
			}
		}
	}
}

function render_new_graph(editid, graphid, args) {
	if(args && args.length) {
		$(editid).val(args);
	}
	save_arguments_to_url();
	/*afterquery.render(read_arguments(editid), data.value,null,graphid);*/
	var to_prune = "#" + graphid + ' .vizchart';
	$(to_prune).empty();
	/* TODO: use cached data if posible */
	load_and_render();
}

function change_view() {
	var duration = $('#data-duration input[type="radio"]:checked').val()
	var source = $('#data-source input[type="radio"]:checked').val()
	if(source == "machines") {
		render_new_graph('#graph1text', 'graph1', graph_args(true, source, duration));
		render_new_graph('#table1text', 'table1', graph_args(false, source, duration));
	} else if (source == "submitters") {
		render_new_graph('#graph1text', 'graph1', graph_args(true, source, duration));
		render_new_graph('#table1text', 'table1', graph_args(false, source, duration));
	} else if(source=="custom") {
		$("#graph1 .vizchart").html("<h2>Not yet implemented</h2>");
		$("#table1 .vizchart").html("<h2>Not yet implemented</h2>");
	}
}

function submitters_data_source() { return "submitters.json"; }
function submitters_now_data_source() { return "submitters.now.json"; }
function machines_data_source() { return "machines.json"; }
function machines_now_data_source() { return "machines.now.json"; }

/*
is_chart - true it's a chart (pie/stacked), false it's a table.
source - submitters or machines
duration - now, day, week, or month
filters - optional. Hash of fields to filter on
   mapped to values to filter by.
title - optional title for chart.
*/
function graph_args(is_chart, source, duration, filters, title) {
	var filter = '';
	if(filters !== undefined) {
		var key;
		for(key in filters) {
			filter += "filter=" + key + "=" + filters[key] + "\n";
		}
	}
	switch(source) {
		case 'submitters':
		{
			if(title === undefined) { title = 'Total Jobs'; }
			var charttype = '';
			if(is_chart) { charttype = 'chart=stacked'; }
			if(duration == 'now') {
				var grouping = 'pivot=Name;JobStatus;Count';
				if(is_chart) {
					charttype = 'chart=pie';
					grouping = "group=JobStatus;Count";
				}
				return "title=" + title + "\n" +
					"url=" + submitters_now_data_source() + "\n" +
					filter +
					"order=JobStatus\n" +
					grouping + "\n" +
					charttype + "\n";

			} else {
				var pivot = "Name;JobStatus;avg(Count)";
				if(is_chart) { pivot = "Date;JobStatus;Count"; }
				return "url=" + submitters_data_source() + "\n" +
					"title=" + title + "\n" +
					filter +
					"order=Date\n" +
					"pivot=" + pivot + "\n" +
					charttype + "\n";
			}
			break;
		}
		case 'machines':
		{
			if(title === undefined) { title = 'Machine State'; }
			if(duration == 'now') {
				if(is_chart) {
					return "title="+title+"\n"+
						"url=machines.now.json\n"+
						"order=State\n"+
						"group=State;Cpus\n"+
						"chart=pie";
				} else {
					return "title="+title+"\n"+
						"url=machines.now.json\n"+
						"order=Arch,OpSys\n"+
						"group=Arch,OpSys;State;Cpus";
				}
			
			} else {
				if(is_chart) {
					return "title=" + title + "\n" +
						"url=" + machines_data_source() + "\n" +
						filter +
						"order=Date\n" +
						"pivot=Date;State;Cpus\n" +
						"chart=stacked\n";
				} else {
					return "url=" + machines_data_source() + "\n" +
						"order=Date\n" +
						"pivot=Date,Arch,OpSys;State;Cpus\n" +
						"group=Arch,OpSys;avg(Unclaimed),avg(Claimed),max(Unclaimed),max(Claimed)";
				}
			}
		}
	}
}

function default_submitters_graph_args() {
	return graph_args(true, 'submitters', 'day');
}

function submitter_graph_args(user) {
	return graph_args(true, 'submitters', 'day', {Name:user}, "Jobs for "+user);
}

function submitter_now_graph_args(user) {
	return graph_args(true, 'submitters', 'now', {Name:user}, "Jobs for "+user);
}

function default_submitters_table_args() {
	return graph_args(false, 'submitters', 'day');
}



function machines_graph_args(arch,opsys) {
	return graph_args(true, 'machines', 'day', {Arch: arch, OpSys: opsys}, "Machine State for "+arch+"/"+opsys);
}

window.onpopstate = function() {
	setTimeout(function(){
		load_arguments_to_form('graph1', '#graph1text');
		load_arguments_to_form('table1', '#table1text');
		load_and_render();
		},1);
}

$('#reloadgraph1').click(function() {
	load_and_render();
	save_arguments_to_url();
	});
$('#rerendergraph1').click(function() { render_new_graph('#graph1text', 'graph1'); });
/*$('#reset_graph1').click(function(){ render_new_graph('#graph1text', * 'graph1', default_graph_args()); });*/

$('#reloadtable1').click(function() {
	load_and_render();
	save_arguments_to_url();
	});
$('#rerendertable1').click(function() { render_new_graph('#table1text', 'table1'); });
/* $('#reset_table1').click(function(){ render_new_graph('#table1text', * 'table1', default_table_args()); }); */

$(document).ready( function() {
	// Initialize tabs
	$('ul.tabs li').click(function(){
		var tab_id = $(this).attr('data-tab');

		$('ul.tabs li').removeClass('current');
		$('.tab-content').removeClass('current');

		$(this).addClass('current');
		$("#"+tab_id).addClass('current');
	});

	$('ul.radio-tabs input').change(change_view);

	// Initialize graph
	if(!window.location.search) {

		$('#graph1text').val(default_submitters_graph_args());
		$('#table1text').val(default_submitters_table_args());
		save_arguments_to_url();
	}
	load_arguments_to_form('graph1', '#graph1text');
	load_arguments_to_form('table1', '#table1text');
	load_and_render();
}) ;

</script>

</body>
</html>
