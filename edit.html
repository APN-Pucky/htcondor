<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>HTCondorView</title>
  <link rel="stylesheet" href="htcondor.css" />
  <link rel="stylesheet" href="htcondorview.css" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dygraph/1.1.0/dygraph-combined.js"></script>
  <script src="https://www.google.com/jsapi"></script>
  <script>
  google.load('visualization', '1.0', {
    packages: ['table', 'corechart', 'treemap', 'annotatedtimeline']
  });
  </script>
  <script src="heatgrid.js"></script>
  <script src="render.js"></script>
  <script src="htcondorview.js"></script>

<style>
#thechart, #thechart .htcondorview, #thechart .htcondorview .graph, #thechart .htcondorview .graph .vizchart {
	width: 100%;
}

</style>
</head>
<body>
<h1 class="htclogo"><img src="HTCondor-View.svg" alt="HTCondor View"></h1>
<h1>Edit Graph</h1>


<div id="thechart"></div>

<div>
Title: <input type="text" id="title" name="title" value="DATA"> (help link)<br>
Data source: <input type="text" id="data_url" name="data_url" value="DATA"> (view link) (help link)<br>
Query: <a href="help.html" target="_blank">syntax reference</a><br>
<textarea rows="10" style="width: 90%;" id="graph_query" name="graph_query">DATA</textarea>
</div>

<!-- vizlog is where errors will go. -->
<div id="vizlog"></div>

<script>
$(document).ready(function(){

	var args = afterquery.parseArgs(window.location.search);
	$('#title').val(args.get('title'));
	$('#data_url').val(args.get('data_url'));

	var graph_query_url = args.get('graph_query');
	var gqargs = afterquery.parseArgs(graph_query_url);
	var graph_query = '';
	var i;
	for(i = 0; i < gqargs.all.length; i++) {
		var pair = gqargs.all[i];
		var key = pair[0];
		var value = pair[1];
		if(key !== '' && value !== '') {
			graph_query += key + "=" + value + "\n";
		}
	}

	$('#graph_query').val(graph_query);
	update_graph();

});

function update_graph() {

	var title = $('#title').val();
	var data_url = $('#data_url').val();
	var graph_query = $('#graph_query').val();
	if((!data_url) || !graph_query) {
		$('#thechart').html("<h1>No graph requested</h1>\n" +
				"<p>At the least a data_url and graph_query argument are required.\n");
		return;
	}

	var graph_query_url = '';
	var gqlines = graph_query.split("\n");
	var i;
	var idx;
	var key;
	var value;
	for(i = 0; i < gqlines.length; i++) {
		idx = gqlines[i].indexOf("=");
		if(idx === -1) {
			key = gqlines[i];
			value = '';
		} else {
			key = gqlines[i].substr(0, idx);
			value = gqlines[i].substr(idx+1);
		}
		graph_query_url += encodeURIComponent(key) + "=" + encodeURIComponent(value) + "&";
	}
	console.log(graph_query_url);
	

	new HTCondorView({
		dst_id: "thechart",
		title: title,
		data_url: data_url,
		graph_query: graph_query_url,
	});
}

</script>

</body>
</html>
