#!/bin/sh

set -e

. $EXTERNALS_CONFIG

# The source tarball was checked out on April 6, 2006 with the following
# command:
#   cvs -d :pserver:anonymous@jra1mw.cvs.cern.ch:/cvs/jra1mw co -r \
#      Experimental_branch4Condor org.glite.ce.blahp

# Adjust for new layout in classad distribution.
patch -i classad.patch -p0

# This patch adds testing for dlopen to configure. This is necessary since
# we're going to be listing the globus libraries explicitly on the command
# line rather than using -l. The original code used -l and the shared
# libraries picked up libdl.so automatically.
patch -i dl.patch -p0

# This patch removes the requirement to have a proxy for all jobs. It's
# needed in EGEE for their DGAS accounting machinery.
patch -i proxy.patch -p0

# These .m4 files come from a different part of the glite repository. These
# are slightly-modified versions. They let us statically link with Globus
# 4.2 and separate OpenSSL libraries (instead of dynamically linking with
# Globus 2.4 with included OpenSSL), remove the check for threaded Globus
# libraries (which aren't used) and use the correct name for the
# namespace-enabled ClassAds library (libclassad_ns instead of libclassad).
cp classads.m4 org.glite.ce.blahp/project
cp globus.m4 org.glite.ce.blahp/project
cp glite.m4 org.glite.ce.blahp/project

# These are extra files generated by automake and friends. They aren't
# included in the repository, but they are included in downloadable
# source tarballs. I snagged them from
# http://glite.web.cern.ch/glite/packages/R3.1/N20060406/src/glite-ce-blahp-1.7.0_src.tar.gz
tar zxvf blahp_extra_files-1.7.0-p2.tar.gz

# This patch renames the blahpd[_daemon] to batch_gahp[_daemon] and
# blah.config to batch_gahp.config.
patch -i name-change.patch -p0
mv org.glite.ce.blahp/config/blah.config org.glite.ce.blahp/config/batch_gahp.config

# This patch tweaks the gahp version string to indicate that it understands
# the new Arguments/Evironment job attributes. It also fixes a problem in
# the blahp that causes it to misinterpret empty Arguments and
# Environment values.
patch -i version.patch -p0

cd org.glite.ce.blahp

echo running configure
./configure --with-classads-prefix=$EXTERNALS_INSTALL_DIR/$EXT_CLASSADS_VERSION --with-openssl-prefix=$EXTERNALS_INSTALL_DIR/$EXT_OPENSSL_VERSION --with-globus-prefix=$EXTERNALS_INSTALL_DIR/$EXT_GLOBUS_VERSION --with-globus-nothr-flavor=$GLOBUS_FLAVOR --prefix=$PACKAGE_INSTALL_DIR/dynamic
# The configure won't find classads or globus, but the make will rebuild and
# rerun configure, at which point everything will be detected correctly
# Why? Because the generated configure in the tarball checks for Globus 2.4
# libraries, both threaded and unthreaded, and is using the wrong name for
# the classads library. The .m4 files we copy in fix this, but then the
# configure and makefiles need to be regenerated.
make
make install

# Now, we need to build static executables
# This configure has no flag to enable static linking, so we hack it by
# adding the flag to the Makefile directly.
if [ "$HAS_STATIC" == "YES" ]
then
  make distclean
  ./configure --with-classads-prefix=$EXTERNALS_INSTALL_DIR/$EXT_CLASSADS_VERSION --with-openssl-prefix=$EXTERNALS_INSTALL_DIR/$EXT_OPENSSL_VERSION --with-globus-prefix=$EXTERNALS_INSTALL_DIR/$EXT_GLOBUS_VERSION --with-globus-nothr-flavor=$GLOBUS_FLAVOR --prefix=$PACKAGE_INSTALL_DIR/static
  sed 's/^LDFLAGS = $/LDFLAGS = -all-static/' src/Makefile >src/Makefile.new
  mv src/Makefile.new src/Makefile
  make
  make install
fi

exit 0
