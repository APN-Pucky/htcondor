%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{\label{sec:vm-install}Virtual Machines}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\index{virtual machines}
\index{installation!vm universe}

Virtual Machines can be executed on any execution site with VMware or Xen
(via \Prog{libvirt}).  To do this, Condor must be informed of some details 
of the VM installation.

What follows is not a comprehensive list of the VM Universe options; rather,
it is intended to serve as a starting point for those users interested in
getting VM Universe up and running quickly.  For further, more comprehensive 
coverage of the configuration options please refer to 
section~\ref{sec:Config-VMs}.

Begin by installing the virtualization package according to the vendor's
instructions.  We have successfully used both VMware Server and Xen. If you
are considering running on a Windows system, you will also need to install
a Perl distribution; for this we have used ActivePerl successfully. 

If you are considering Xen, then there are four things that must exist on 
a system to fully support it. First, a Xen kernel must be running on the 
execute machine. This running Xen kernel acts as Dom0, in Xen terminology, 
under which all VMs are started, called DomUs Xen terminology. Second, 
the \Prog{libvirtd} daemon must be available, and \Prog{Xend} services must be running. 
Third, a reasonably recent version of the \Prog{mkisofs} utility must be available, 
for creation of CD-ROM disk images. Fourth, the \Prog{pygrub} program must be 
available, for execution of VMs whose disks contain the kernel they will run.

If you are considering KVM, then there are three things that must exist on a 
system to fully support it.  First, the machine must have the kvm kernel 
module installed and running.  Second, the \Prog{libvirtd} daemon must be 
installed and running.  Third, a reasonably recent version of the \Prog{mkisofs} 
utility must be available, for creation of CD-ROM disk images.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Configuration Parameters}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

There are a number of configuration parameters related to virtual
machines. Some options are required, while others are 
optional.  Here we only discuss those that are required.

First, you are required to specify the type of VM that is installed. 
For instance, the following tells Condor we are using VMware:

\begin{verbatim}
VM_TYPE = vmware
\end{verbatim}

You are also required to specify the location of \Condor{vm-gahp} and
its log file.
On a Windows installation, these options would look like this:

\begin{verbatim}
VM_GAHP_SERVER = $(SBIN)/condor_vm-gahp.exe
VM_GAHP_LOG = $(LOG)/VMGahpLog
\end{verbatim}

%You must also provide a version string for the Virtual Machine software
%you are using:

%\begin{verbatim}
%VM_VERSION = server1.0.4
%\end{verbatim}

%While required, this option does not alter the behavior of Condor.
%Instead, it is added to the ClassAd for the machine, so it 
%can be matched against.  This way, if future releases of VMware/Xen support
%new features that are desirable for your job, you can match on this string.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{VMware-Specific Configuration}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

If you are using VMware you also need to set the location of the Perl 
executable.  In most cases, however, the default value should suffice:

\begin{verbatim}
VMWARE_PERL = perl
\end{verbatim}

This, of course, assumes the Perl executable is in the path.  If this is not 
the case, then a full path to the Perl executable will be required.

The final required option is the location of the VMware control script. It's
located in Condor's sbin directory:

\begin{verbatim}
VMWARE_PERL = $(SBIN)/condor_vm_vmware.pl
\end{verbatim}

Finally, note that an execute machine's \Macro{EXECUTE} setting should not
contain any symlinks in its path if the machine is configured to run VMware
jobs. See the FAQ entry in section~\ref{sec:vmware-symlink-bug} for details.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Xen and KVM-Specific Configuration}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Xen and KVM configurations must set the location of the control script Condor
uses to interact with Xen:

\begin{verbatim}
VM_SCRIPT = $(SBIN)/condor_vm_xen.sh
\end{verbatim}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\subsection{}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Once the configuration options have been set, restart the \Condor{startd} 
daemon on that host.  For example:

\begin{verbatim}
> condor_restart -startd leovinus
\end{verbatim}

The \Condor{startd} daemon takes a few moments to exercise the VM
capabilities of the \Condor{vm-gahp}, query its properties, and then 
advertise the machine to the pool as VM-capable.  If the set up 
succeeded, then \Condor{status} will tell you the host is now 
VM-capable by printing the VM type and the version number:

\begin{verbatim}
> condor_status -vm leovinus
\end{verbatim}

After a suitable amount of time, if this command does not give any output,
then the \Condor{vm-gahp} is having difficulty executing the VM software.
The exact cause of the problem depends on the details of the VM, the local 
installation, and a variety of other factors. We can offer only limited 
advice on these matters:

For Xen and KVM, the VM Universe is only available when root starts Condor.
This is a restriction currently imposed because root privileges are 
required to create a VM on top of a Xen kernel. Specifically, root is needed 
to properly use the \Prog{libvirt} utility that controls 
creation and management of Xen and KVM guest virtual machines. This restriction 
may be lifted in future versions depending on features provided by the 
underlying tools, \Prog{libvirt}.
