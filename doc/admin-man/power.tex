%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{\label{sec:power-man}Power Management}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\index{power management|(}
\index{installation!power management}
On the Windows platform,
Condor can be configured to place a machine in a low power state.  
The details of the machine's power capabilities are in the
configuration. 

This section discusses a starting point for users interested in 
experimenting with power conservation within their Condor pool.
Power conservation is relevant when machines are not in heavy use,
or when there are known periods of low activity within the pool.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Configuration to Enter a Low Power State}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

By default, Condor's does not do power management.
When desired, the ability to place a machine into a low
power state is accomplished through configuration.
This occurs when all slots on a machine agree that a low power state
is desired.

A slot's readiness to hibernate is determined by the 
evaluating the \Macro{HIBERNATE} expression in the context of the slot.
Readiness is evaluated on at fixed intervals, 
as determined by the configuration variable
\Macro{HIBERNATE\_CHECK\_INTERVAL}.
A non-zero value enables the power management facility.
It is an integer value representing seconds,
an it need not be a small value.
There is a trade off between the accuracy of measurement and 
the unnecessary computation of readiness.  

To put the machine in a low power state rapidly
after it has become idle, consider checking each slot's state frequently,
as in the example configuration:

\begin{verbatim}
HIBERNATE_CHECK_INTERVAL = 20
\end{verbatim}

This checks each slot's readiness every 20 seconds.
A more common value for frequency of checks is 300 (5 minutes).
A value of 300 loses some degree of granularity,
but it is more reasonable as machines are likely to be put 
in to a low power state after a few hours, rather than minutes.
 
A slot's readiness or willingness to enter a low power state is 
determined by the \MacroNI{HIBERNATE} expression. 
Because this expression is evaluated in the context of each slot,
and not on the machine as a whole, 
any one slot can veto a change of power state.  
The \MacroNI{HIBERNATE} expression may include a wide array of variables.
Possibilities include the change in power state if 
none of the slots are claimed, or if the slots are not in the
Owner state.
See the description of \MacroNI{HIBERNATE} in
section~\ref{param:Hibernate} on page~\pageref{param:Hibernate}
for definitions of the values representing the different
power states.

Here is a concrete example.
Assume that the \MacroNI{START} expression is not set to
always be \Expr{True}.
This permits an easy determination whether or not
the machine is in an Unclaimed state through the use of
an auxiliary macro called \MacroNI{ShouldHibernate}.

\begin{verbatim}
ShouldHibernate = ((KeyboardIdle > $(StartIdleTime)) \
                  && $(CPUIdle) \
                  && ($(StateTimer) > (2 * $(HOUR)))
\end{verbatim}

This macro evaluates to \Expr{True} if
\begin{itemize}
\item The keyboard has been idle long enough.
\item The CPU is idle
\item The slot has been Unclaimed for more than 2 hours.
\end{itemize}

The \MacroNI{HIBERNATE} expression becomes

\begin{verbatim}
HIBERNATE = ifThenElse($(ShouldHibernate), ``RAM'', ``NONE'' )
\end{verbatim}

In words, this expresses:
enter power state ''RAM'',
if \MacroNI{ShouldHibernate} evaluates to \Expr{True}; 
otherwise, enter power state ''NONE'',
which leaves the machine in its current state.   Unknown names are
treated as ``NONE''.

If any slot returns ''NONE'',
it vetoes the decision to enter a low power state.
Only when values returned by all slots are all non-zero 
is there a decision to enter a low power state.
If all agree to enter the low power state, but differ in which state to enter,
then the largest magnitude value is chosen. 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Linux}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Depending on the Linux distribution and version, there are 3 different
methods for controlling the system's power state.  The methods are:
\begin{itemize}
\item pm-utils is a set of command-line tools which can be used to
  detect and switch power states.  In Condor, this is named ``pm-utils''.
\item The /sys/power virtual directory has sever virtual files that
  can be used to detect / set the power states.  In Condor, this is
  name ``/sys''.
\item The /proc/acpi virtual directory has sever virtual files that
  can be used to detect / set the power states.  In Condor, this is
  name ``/proc''.
\end{itemize}

By default, the Condor Linux hibernator attempts to detect the method
to use in the above order.  The first method that's detected as usable
on the system will be used.

This behavior can be overridden by specifying the
\MacroNI{LINUX\_HIBERNATION\_METHOD} configuration parameter -- it
should be set to one of the above names (``pm-utils'', ``/sys'', or
``/proc'').
See the description of \MacroNI{LINUX\_HIBERNATION\_METHOD} in
section~\ref{param:LinuxHibernationMethod} on
page~\pageref{param:LinuxHibernationMethod}
for details on overriding this behavior.

If no usable methods are detected, or the method specified by
\MacroNI{LINUX\_HIBERNATION\_METHOD} be either not detected or
invalid, hibernation will be disabled.

The details of this selection process, and the final method selected
can be logged via enabling \MacroNI{D\_FULLDEBUG} in the relevant
subsystem's log configuration.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Returning From a Low Power State}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Condor version 7.1.3 does not provide the service of waking a machine
that is in a low power state.
This functionality is planned for a future release.

The machine ClassAd has all the information needed for a remote
user to wake it by external means.
This includes the public IP machine address,
as well as the subnet the machine resides on.
Using this information,
the remote user may use available wake on LAN (WOL) tools 
to wake a machine.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Troubleshooting}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

If after a suitable amount of time,
the machine has not entered the expected power state,
then Condor is having difficulty exercising the operating system's
low power capabilities.  
While the cause will be specific to the machine's hardware,
it may also be due to improperly configured software.  
For hardware difficulties,
the likely culprit is the configuration within the machine's BIOS,
for which Condor can offer little guidance.
For operating system difficulties,
the Vista the \Prog{powercfg} tool can be used to discover the available 
power states on the machine.
The following command demonstrates how to
list all of the supported power states of the machine:

\begin{verbatim}
> powercfg -A
The following sleep states are available on this system: 
Standby (S3) Hibernate Hybrid Sleep
The following sleep states are not available on this system:
Standby (S1)
        The system firmware does not support this standby state.
Standby (S2)
        The system firmware does not support this standby state.
\end{verbatim}

Note that the \MacroNI{HIBERNATE} expression is written in terms of the 
S$n$ state, where $n$ is the value evaluated from the expression.

This tool can also be used to enable and disable other sleep states.
This example turns hibernation on.

\begin{verbatim}
> powercfg -h on
\end{verbatim}

If this tool is insufficient for configuring the machine in the manner required,
the \Prog{Power Options} control panel application offers
the full extent of the machine's power management abilities.
Windows 2000 and XP lack the \Prog{powercfg} program,
so all configuration must be done via the \Prog{Power Options}
control panel application.

\index{power management|)}
