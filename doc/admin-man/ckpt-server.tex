%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{\label{sec:Ckpt-Server}
Installing a Checkpoint Server}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
The Checkpoint Server is a repository for checkpoint files.
Using checkpoint servers reduces the disk requirements of submitting
machines in the pool since they no longer need to store checkpoint
files locally.
Checkpoint server machines should have a large amount of disk space
available, and should have a fast connection to machines in the Condor
pool.

\Note It is a good idea to pick very stable machines for your checkpoint
servers.
If the checkpoint servers crash, the Condor system will continue to
operate, though poorly.  
While the Condor system will recover from a checkpoint server crash
as best it can, there are two problems that can (and will) occur:
\begin{enumerate}

\item If the checkpoint server is not functioning, when jobs need to
checkpoint, they cannot do so.
The jobs will keep trying to contact the checkpoint server, backing
off exponentially in the time they wait between attempts.
Normally, jobs only have a limited time to checkpoint before they are
kicked off the machine.
So, if the server is down for a long period of time, chances are that
you'll lose a lot of work by jobs being killed without writing a
checkpoint. 

\item When the jobs wish to start, if their checkpoints cannot be
retrieved from 
the checkpoint server, they will either have to be restarted from
scratch, or the job will wait for the server to come back on-line.
You can control this behavior with the
\Macro{MAX\_DISCARDED\_RUN\_TIME} parameter in your config file (see
section~\ref{sec:Checkpoint-Server-Config-File-Entries} on
page~\pageref{sec:Checkpoint-Server-Config-File-Entries} for details).
Basically, this represents the maximum amount of CPU time you're
willing to discard by starting a job over from scratch if the
checkpoint server isn't responding to requests.

\end{enumerate}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\label{sec:Prepare-Ckpt-Server}
Preparing to Install a Checkpoint Server} 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Because of the problems that exist if your pool is configured to use a
checkpoint server and that server is down, it is advisable to shut
your pool down before doing any maintenance on your checkpoint
server.  
See section~\ref{sec:Pool-Management} on
page~\pageref{sec:Pool-Management} for details on how to do that. 

When modifying the checkpoint server configuration of a submission
machine, you must make sure there are no jobs currently in the queue
on that machine.
If you have jobs in your queues, with checkpoint files on the local
spool directories of your submit machines, those jobs will never run
if your submit machines are configured to use a checkpoint server and
the checkpoint files cannot be found on the server.  
You can either remove jobs from your queues or let them complete
before you configure those submission machines with non-empty job
queues.
However, you may proceed and install the checkpoint server,
configuring only those submission machines with empty queues and
postponing the configuration of submission machines with non-empty job
queues until the queues are empty.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\label{sec:Install-Ckpt-Server-Module}
Installing the Checkpoint Server Module} 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

To install a checkpoint server, download the appropriate binary
contrib module for the platform(s) your server will run on.
When you uncompress and untar the file, you'll have a directory that
contains a \File{README}, \File{ckpt\_server.tar}, and so on.
The \File{ckpt\_server.tar} acts much like the \File{release.tar} file
from a main release.
This archive contains these files:
\begin{verbatim}
        sbin/condor_ckpt_server
        sbin/condor_cleanckpts
        etc/examples/condor_config.local.ckpt.server
\end{verbatim}
These are all new files, not found in the main release, so you can
safely untar the archive directly into your existing release
directory. 
\File{\condor{ckpt\_server}} is the checkpoint server binary.
\File{\condor{cleanckpts}} is a script that can be periodically run to
remove stale checkpoint files from your server.  
Normally, the checkpoint server cleans all old files by itself.  
However, in certain error situations, stale files can be left that are
no longer needed. 
So, you may want to put a cron job in place that calls
\Condor{cleanckpts} every week or so, just to be safe.
The example config file is described below.

Once you have unpacked the contrib module, you have a few more steps
you must complete.
Each will be discussed in their own section:
\begin{enumerate}
\item Configure the checkpoint server.
\item Spawn the checkpoint server.
\item Configure your pool to use the checkpoint server.
\end{enumerate}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\label{sec:Configure-Ckpt-Server}
Configuring a Checkpoint Server} 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

There are a few settings you must place in the local config file of
your checkpoint server.  
The file \File{etc/examples/condor\_config.local.ckpt.server} contains
all such settings, and you can just insert it into the local
configuration file of your checkpoint server machine. 

There is one setting that you must customize, and that is
\Macro{CKPT\_SERVER\_DIR}.  
\label{param:CkptServerDir}
The \Macro{CKPT\_SERVER\_DIR} defines where your checkpoint files
should be located. 
It is better if this is on a very fast local file system (preferably a
RAID). 
The speed of this file system will have a direct impact on the speed
at which your checkpoint files can be retrieved from the remote
machines. 

The other optional settings are:
\begin{description}

\item[\Macro{DAEMON\_LIST}] (Described in
section~\ref{sec:Master-Config-File-Entries}).  
If you want the checkpoint server managed by the \Condor{master}, the
\Macro{DAEMON\_LIST} entry must have MASTER and CKPT\_SERVER.
Add STARTD if you want to allow jobs to run on your checkpoint server.
Similarly, add SCHEDD if you would like to submit jobs from your
checkpoint server. 

\end{description}

The rest of these settings are the checkpoint-server specific versions
of the Condor logging entries, described in
section~\ref{sec:Daemon-Logging-Config-File-Entries} on
page~\pageref{sec:Daemon-Logging-Config-File-Entries}.
\begin{description}

\item[\Macro{CKPT\_SERVER\_LOG}] The CKPT\_SERVER\_LOG is where the
checkpoint server log gets put.

\item[\Macro{MAX\_CKPT\_SERVER\_LOG}] Use this item to configure the
size of the checkpoint server log before it is rotated.

\item[\Macro{CKPT\_SERVER\_DEBUG}] The amount of information you would
like printed in your logfile.
Currently, the only debug level supported is \Dflag{ALWAYS}.

\end{description}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\label{sec:Spawn-Ckpt-Server} 
Spawning a Checkpoint Server} 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

To spawn a checkpoint server once it is configured to run on a given
machine, all you have to do is restart Condor on that host to enable
the \Condor{master} to notice the new configuration.
You can do this by sending a \Condor{restart} command from any machine
with ``administrator'' access to your pool.
See section~\ref{sec:Host-Security} on
page~\pageref{sec:Host-Security} for full details about IP/host-based
security in Condor.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\label{sec:Configure-Pool-Ckpt-Server} 
Configuring your Pool to Use the Checkpoint Server}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Once the checkpoint server is installed and running, you just have to
change a few settings in your config files to let your pool know
about your new server:
\begin{description}

\item[\Macro{USE\_CKPT\_SERVER}] This parameter should be set to
``True''.

\item[\Macro{CKPT\_SERVER\_HOST}] This parameter should be set to
the full hostname of the machine that is now running your checkpoint
server.  

\end{description}

It most convenient to set these parameters in your global config file
so they are in effect for all submission machines.
However, you may configure each submission machine separately (using
local config files) if you do not want all of your submission machines
to use a checkpoint server at this time.
If \Macro{USE\_CKPT\_SERVER} is set to ``False'' or is undefined, the
submission machine will not use a checkpoint server.

Once these settings are in place, you simply have to send a
\Condor{reconfig} to all machines in your pool so the changes take
effect.
This is described in section~\ref{sec:Reconfigure-Pool} on
page~\pageref{sec:Reconfigure-Pool}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\label{sec:Configure-Multiple-Ckpt-Server} 
Configuring your Pool to Use Multiple Checkpoint Servers}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

It is possible to configure a Condor pool to use multiple checkpoint
servers.
This enables the administrator to deploy checkpoint servers across the
network to improve checkpointing performance.
In this case, Condor machines are configured to checkpoint to the
``nearest'' checkpoint server.
There are two main benefits to deploying multiple checkpoint
servers:
\begin{itemize}
\item Checkpoint-related network traffic may be localized by
intelligent placement of checkpoint servers.
\item Faster checkpointing means that jobs spend less time
checkpointing (and more time doing useful work), jobs have a better
chance of checkpointing successfully when vacated, and workstation
owners see Condor jobs vacate their machines more quickly.
\end{itemize}

Once you have multiple checkpoint servers running in your pool, the
following configuration changes are required to make them active.

First, \Macro{USE\_CKPT\_SERVER} should be set to ``True'' on all
submission machines whose jobs should use a checkpoint server.
Additionally, \Macro{STARTER\_CHOOSES\_CKPT\_SERVER} should be set to
``True'' on these submission machines.
When true, this parameter specifies that the checkpoint server
specified by the execution machine should be used instead of the
checkpoint server specified by the submission machine.
(See section~\ref{sec:Checkpoint-Server-Config-File-Entries} on
page~\pageref{sec:Checkpoint-Server-Config-File-Entries} for more
details.)
This allows the job to use the checkpoint server closest to the
machine on which it is running, instead of the server closest to the
submission machine.
For convenience, we suggest that you set these parameters in the
global config file.

Next, you must set \Macro{CKPT\_SERVER\_HOST} on each machine.
As described above, this should be set to the full hostname of the
checkpoint server machine.
In the case of multiple checkpoint servers, you will want to set this
to be the hostname of the nearest server for each machine in the local
config file.

Finally, once these settings are in place, you simply have to send a
\Condor{reconfig} to all machines in your pool so the changes take
effect.
This is described in section~\ref{sec:Reconfigure-Pool} on
page~\pageref{sec:Reconfigure-Pool}.

Now, the jobs in your pool will checkpoint to the nearest checkpoint
server.
On restart, the job will remember where its checkpoint was
stored and read it from the appropriate server.
After a job successfully writes a checkpoint to a new server, it will
remove any previous checkpoints left on other servers.

\Note If the configured checkpoint server is unavailable, the job will
keep trying to contact that server as described above.
It will not use alternate checkpoint servers.
This may change in future versions of Condor.
