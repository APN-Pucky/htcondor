#! /usr/bin/env perl
BEGIN { $^W = 1 }
use strict;
use FindBin;

exit main();

sub main {
	my $glite_path = $FindBin::Bin;
	my $bin_path = $glite_path;
	$bin_path =~ s|/libexec/glite/*|/bin|;
	my $sbin_path = $bin_path;
	$sbin_path =~ s|/bin/*|/sbin|;
	$ENV{PATH} = "$bin_path:$sbin_path:$ENV{PATH}";

	print "Starting Condor-C Launcher\n";
	if ( check( "condorc-launcher" ) == 0 ) {
		print "Skipping Condor-C Launcher\n";
	} else {
		submit($glite_path,'condorc-launcher');
	}
	print "Starting Condor-C Advertiser\n";
	if ( check( "condorc-advertiser" ) == 0 ) {
		print "Skipping Condor-C Advertiser\n";
	} else {
		submit($glite_path,'condorc-advertiser');
	}
}

sub check {
	my($executable) = @_;
	my @jobs = `condor_q -format '\%s\n' Cmd `;
	if ( $? != 0 ) {
		print "condor_q failed!\n";
		return 0;
	}
	foreach ( @jobs ) {
		if ( /$executable\n/ ) {
			print "$executable already submitted!\n";
			return 0;
		}
	}
	return 1;
}

sub submit {
	my($bin_path,$executable) = @_;
	my $fullpath = "$bin_path/$executable";
	if( ! -e $fullpath ) {
		print STDERR "Warning: $fullpath does not exist.\n";
	}
	if( ! -x $fullpath ) {
		print STDERR "Warning: $fullpath is not executable.\n";
	}
	local *OUT;
	open(OUT, "|condor_submit")
		or die "FATAL ERROR: unable to launch condor_submit";
	print OUT <<END;
executable=$fullpath
universe=scheduler
output=/tmp/$executable.$>.$$.out
error=/tmp/$executable.$>.$$.err
environment=PATH=$ENV{PATH}
notification=never
on_exit_remove=false
queue
END
	close OUT;
}
