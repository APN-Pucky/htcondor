CMNT
CMNT Set the following if you want a PVM ready checkpointing library
CMNT compiled.  This will require that the PVM library be linked into
CMNT the application.
CMNT

PVM_CHECKPOINT = -DPVM_CHECKPOINTING

FILE_TABLE = -DFILE_TABLE
FILE_TABLE_OBJ = file_state.o condor_file.o condor_file_local.o condor_file_remote.o condor_file_special.o condor_file_agent.o condor_file_buffer.o file_table_interf.o switches.o switches.special.o

#if DOES_SAVE_SIGSTATE
SAVE_SIGSTATE = -DSAVE_SIGSTATE
SAVE_SIGSTATE_OBJ = signals_support.o signals_control.o

#if IS_DUX
SIG_EXTRACT = SIGACTION.o SIGPROCMASK.o SIGSUSPEND.o SIGNAL.o _SIGSUSPEND.o
#elif IS_X86_SOLARIS
SIG_EXTRACT = SIGACTION.o _SIGACTION.o i386_data.o
#elif IS_SUN4X_SOLARIS
SIG_EXTRACT = SIGACTION.o _SIGACTION.o
#elif IS_LINUX
SIG_EXTRACT = SIGSUSPEND.o
#endif

#endif  /* ======= of if DOES_SAVE_SIGSTATE ==========*/

#if IS_GLIBC_LINUX
PLATFORM_EXTRACT = MMAP.o SYSCALL.o SYSDEP.o PIPE.o
#elif IS_LINUX
PLATFORM_EXTRACT = MMAP.o SYSCALL.o __PIPE.o
#elif IS_SOLARIS
PLATFORM_EXTRACT = MMAP.o SYSCALL.o PIPE.o
#elif IS_ALPHA_OSF1
PLATFORM_EXTRACT = MMAP.o SYSCALL.o PIPE.o
#elif IS_HPUX
PLATFORM_EXTRACT = SYSCALL.o __SYSCALL.o PIPE.o
#elif IS_IRIX
#else 
PLATFORM_EXTRACT = PIPE.o
#endif

EXTRACT = $(SIG_EXTRACT) $(PLATFORM_EXTRACT)

#if DOES_COMPRESS_CKPT
#if IS_SUN4X_SOLARIS
COMPRESS_OBJ = malloc.o zimage.o _rem.o _div.o umultiply.o
#else
COMPRESS_OBJ = malloc.o zimage.o
#endif
COMPRESS_FLAGS = -DCOMPRESS_CKPT -I/s/zlib/include
COMPRESS_LIB = libcondorzckpt.a
#endif

#if HAS_DYNAMIC_USER_JOBS
DYNAMIC_FLAGS = -DHAS_DYNAMIC_USER_JOBS
#else
DYNAMIC_FLAGS =
#endif

C_PLUS_FLAGS = $(STD_C_PLUS_FLAGS) $(SAVE_SIGSTATE) $(STATIC) \
	$(FILE_TABLE) $(PVM_CHECKPOINT) -DIN_CKPT_LIB $(DYNAMIC_FLAGS)

#if IS_HPUX10
CFLAGS = $(STD_C_FLAGS) $(STATIC) -DIN_CKPT_LIB $(DYNAMIC_FLAGS)
#else
CFLAGS = $(STD_C_FLAGS) -DIN_CKPT_LIB $(DYNAMIC_FLAGS)
#endif

#if IS_IRIX62
OS = IRIX62
#elif IS_IRIX65
OS = IRIX65
#elif IS_HPUX10
OS = HPUX10
#else
OS = OperatingSystem
#endif

#if IS_SGI_IRIX65
ASSEMBLER_OBJ = SYSCALL.MIPS.IRIX65.o MMAP.MIPS.IRIX65.o
.s.o:
	gcc -c -o $*.o $*.s
#endif

#if IS_SGI_IRIX62
ASSEMBLER_OBJ = SYSCALL.MIPS.IRIX62.o MMAP.MIPS.IRIX62.o
.s.o:
	gas -o $*.o $*.s
#endif

CPP_UTIL_OBJ = condor_version.o

UTIL_OBJ =  dprintf_common.o mkargv.o condor_error.o

#if DOES_CHECKPOINTING
OBJ =	image.o machdep.$(OS).o tmp_stack.o syscall_mode.o \
	local_startup.o fake_remote_syscall.o fake_hooks.o \
	$(SAVE_SIGSTATE_OBJ) fake_util_lib.o eprintf.o $(EXTRACT) \
	$(ASSEMBLER_OBJ) $(CPP_UTIL_OBJ) $(UTIL_OBJ) $(FILE_TABLE_OBJ) shared_utils.o

#else /* !DOES_CHECKPOINTING */

OBJ =	syscall_mode.o shared_utils.o

#endif

#   if IS_EGCS_BUILD
        CPP_SUPPORT_OBJ = c_plus_alloc.o _eh.o tinfo.o tinfo2.o \
			  exception.o frame.o __dummy.o _pure.o
#   else 
        CPP_SUPPORT_OBJ = c_plus_alloc.o pure_virtual.o
#   endif

#if DOES_CHECKPOINTING

    all_target(ToUpper libcondorckpt.a libcondorc++support.a condor_rt0.o \
	       $(COMPRESS_LIB) $(RELEASE_OBJ) )

    library_target(libcondorc++support.a,$(CPP_SUPPORT_OBJ))

#if IS_X86_SOLARIS || IS_GLIBC_LINUX
	library_target(libtmp.a,$(OBJ))

clean::
	rm -f libcondorckpt.a

libcondorckpt.a: libtmp.a ToUpper
#   if (IS_X86_SOLARIS)
	./ToUpper libtmp.a libcondorckpt.a __cerror __CERROR
#   else /* GLIBC Linux */
	./ToUpper libtmp.a libcondorckpt.a __syscall_error __SYSCALL_ERROR
#   endif /* Solaris */
#else  /* Not GLIBC Linux or Intel Solaris */

	library_target(libcondorckpt.a,$(OBJ))

#endif /* GLIBC Linux or Intel Solaris */

	release_library(libcondorckpt.a,$(RELEASE_DIR)/lib)
	release_target(libcondorc++support.a,$(RELEASE_DIR)/lib,OBJECT_MODE)

	strip_library(libcondorckpt.a,$(STRIP_DIR)/lib)
	strip_library(libcondorc++support.a,$(STRIP_DIR)/lib)

	static_library(libcondorckpt.a,$(STATIC_DIR)/lib)
	static_library(libcondorc++support.a,$(STATIC_DIR)/lib)

#if	DOES_COMPRESS_CKPT
	release_library($(COMPRESS_LIB),$(RELEASE_DIR)/lib)
	strip_library($(COMPRESS_LIB),$(STRIP_DIR)/lib)
	static_library($(COMPRESS_LIB),$(STATIC_DIR)/lib)
#endif

#else /* Not DOES_CHECKPOINTING */

all_target($(OBJ) ToUpper)
release: all
stripped: all
static: all

#endif


#if IS_HPUX
SIGNAL.o :  $(SIMPLE_LIBC)  ToUpper
	ar x    $(SIMPLE_LIBC)      signal.o      ; mv  signal.o  $(TMP_DIR)
	./ToUpper $(TMP_DIR)/signal.o   SIGNAL.o   signal   SIGNAL
	rm -f $(TMP_DIR)/signal.o
	mv SIGNAL.o tmp1
	./ToUpper tmp1 SIGNAL.o _SIGNALvector _signalvector
	rm -f tmp1
#else
uppercase_target($(SIMPLE_LIBC),signal.o,SIGNAL.o,signal,SIGNAL)
#endif

#if IS_X86_SOLARIS
i386_data.o : $(SIMPLE_LIBC)
	ar x $(SIMPLE_LIBC) i386_data.o
#endif

uppercase_target($(SIMPLE_LIBC),sigvec.o,SIGVEC.o,sigvec,SIGVEC)
uppercase_target($(SIMPLE_LIBC),_sigvec.o,_SIGVEC.o,_sigvec,_SIGVEC)

#if IS_X86_SOLARIS
SIGACTION.o : ToUpper $(SIMPLE_LIBC)
	ar x $(SIMPLE_LIBC) sigaction.o
	./ToUpper sigaction.o sigaction.tmp.o sigaction SIGACTION
	./ToUpper sigaction.tmp.o SIGACTION.o _siguhandler _SIGUHANDLER
	rm -f sigaction.tmp.o sigaction.o
#elif IS_ALPHA_OSF1
uppercase_target($(SIMPLE_LIBC),mmap.o,MMAP.o,mmap,MMAP)
#else
uppercase_target($(SIMPLE_LIBC),sigaction.o,SIGACTION.o,sigaction,SIGACTION)
#endif

#if IS_SOLARIS
uppercase_target($(SIMPLE_LIBC),mmap.o,MMAP.o,mmap,MMAP)
uppercase_target($(SIMPLE_LIBC),syscall.o,SYSCALL.o,syscall,SYSCALL)
uppercase_target($(SIMPLE_LIBC),_sigaction.o,_SIGACTION.o,sigaction,SIGACTION)
#endif

uppercase_target($(SIMPLE_LIBC),sigprocmask.o,SIGPROCMASK.o,sigprocmask,SIGPROCMASK)

#if IS_ALPHA_OSF1
SIGSUSPEND.o :  $(SIMPLE_LIBC)  ToUpper
	ar x    $(SIMPLE_LIBC)      sigsuspend.o 	  ; mv  sigsuspend.o  $(TMP_DIR)
	./ToUpper $(TMP_DIR)/sigsuspend.o   $(TMP_DIR)/SIGSUSPEND.o   sigsuspend   SIGSUSPEND
	./ToUpper $(TMP_DIR)/SIGSUSPEND.o SIGSUSPEND.o __SIGSUSPEND_nc __sigsuspend_nc
	rm -f $(TMP_DIR)/sigsuspend.o $(TMP_DIR)/SIGSUSPEND.o

_SIGSUSPEND.o : $(SIMPLE_LIBC) ToUpper
	ar x $(SIMPLE_LIBC) _sigsuspend.o ; mv _sigsuspend.o $(TMP_DIR)
	./ToUpper $(TMP_DIR)/_sigsuspend.o _SIGSUSPEND.o sigsuspend SIGSUSPEND
	rm -f $(TMP_DIR)/_sigsuspend.o

SIGACTION.o : $(SIMPLE_LIBC) ToUpper
	ar x $(SIMPLE_LIBC) sigaction.o; mv sigaction.o $(TMP_DIR)
	./ToUpper $(TMP_DIR)/sigaction.o $(TMP_DIR)/SIGACTION.o sigaction SIGACTION
	./ToUpper $(TMP_DIR)/SIGACTION.o SIGACTION.o _sigtramp _SIGTRAMP
	rm -f $(TMP_DIR)/sigaction.o $(TMP_DIR)/SIGACTION.o

#elif IS_GLIBC_LINUX && IS_GLIBC20
uppercase_target($(SIMPLE_LIBC),sigsuspend.o,SIGSUSPEND_TMP.o,sigsuspend,SIGSUSPEND)

SIGSUSPEND.o: SIGSUSPEND_TMP.o ToUpper
	./ToUpper SIGSUSPEND_TMP.o SIGSUSPEND.o __syscall_SIGSUSPEND __syscall_sigsuspend

clean::
	rm -f SIGSUSPEND_TMP.o

#else
uppercase_target($(SIMPLE_LIBC),sigsuspend.o,SIGSUSPEND.o,sigsuspend,SIGSUSPEND)
#endif

#if IS_LINUX
uppercase_target($(SIMPLE_LIBC),mmap.o,MMAP.o,mmap,MMAP)
#endif


#if IS_EGCS_BUILD
obj_extract($(EGCS_LIBC),_eh.o) 
obj_extract($(EGCS_LIBC),tinfo.o) 
obj_extract($(EGCS_LIBC),tinfo2.o) 
obj_extract($(EGCS_LIBC),__dummy.o) 
obj_extract($(EGCS_LIBC),_pure.o) 
obj_extract($(EGCS_LIBC),exception.o) 
obj_extract($(EGCS_LIBC),frame.o) 
#endif

#if IS_GLIBC_LINUX
uppercase_target($(SIMPLE_LIBC),sysdep.o,SYSDEP_TMP.o,__syscall_error,__SYSCALL_ERROR)
uppercase_target($(SIMPLE_LIBC),syscall.o,SYSCALL_TMP.o,syscall,SYSCALL)

SYSCALL.o: SYSCALL_TMP.o ToUpper
	./ToUpper SYSCALL_TMP.o SYSCALL.o __SYSCALL_error __syscall_error

SYSDEP.o: SYSDEP_TMP.o ToUpper
	./ToUpper SYSDEP_TMP.o SYSDEP_TMP2.o errno ERRNO
	./ToUpper SYSDEP_TMP2.o SYSDEP.o _ERRNO_location _errno_location

clean::
	rm -f SYSCALL_TMP.o
#elif IS_LINUX || IS_DUX || IS_HPUX
uppercase_target($(SIMPLE_LIBC),syscall.o,SYSCALL.o,syscall,SYSCALL)
uppercase_target($(SIMPLE_LIBC),__syscall.o,__SYSCALL.o,__syscall,__SYSCALL)
#endif

uppercase_target($(SIMPLE_LIBC),pipe.o,PIPE.o,pipe,PIPE)
uppercase_target($(SIMPLE_LIBC),__pipe.o,__PIPE.o,__pipe,__PIPE)

#if IS_SOLARIS
program_target(machdep_test,machdep_test.o machdep.$(OS).o tmp_stack.o $(ASSEMBLER_OBJ) MMAP.o SYSCALL.o fake_util_lib.o, )
#else
program_target(machdep_test,machdep_test.o machdep.$(OS).o tmp_stack.o $(ASSEMBLER_OBJ) fake_util_lib.o, )
#endif

program_target(ToUpper,ToUpper.o,$(NULL))

#if DOES_COMPRESS_CKPT
malloc.o : malloc.c
	CCompiler -O2 -g -DMORECORE=condor_morecore -DHAVE_MMAP=0 -Dmalloc_getpagesize=8192 -c malloc.c
zimage.o : image.C
	CPlusCompiler $(C_PLUS_FLAGS) $(COMPRESS_FLAGS) -o zimage.o -c image.C
#if IS_SUN4X_SOLARIS
_rem.o : $(SIMPLE_LIBC)
	ar x $(SIMPLE_LIBC) _rem.o
_div.o : $(SIMPLE_LIBC)
	ar x $(SIMPLE_LIBC) _div.o
umultiply.o : $(SIMPLE_LIBC)
	ar x $(SIMPLE_LIBC) umultiply.o
#endif
$(COMPRESS_LIB): libcondorckpt.a $(COMPRESS_OBJ)
	cp libcondorckpt.a $(COMPRESS_LIB)
	ar -d $(COMPRESS_LIB) image.o
	ar -r $(COMPRESS_LIB) $(COMPRESS_OBJ)
clean::
	rm -f $(COMPRESS_LIB) $(COMPRESS_OBJ)
#endif

CMNT
CMNT The libc entry points to the file table are built
CMNT using the same mechanism as the syscall library.
CMNT

IMPORT_LINKS = ../../config/import_links
import(../condor_util_lib,stub_gen)
import(../condor_syscall_lib,linux_kernel_stat.h)
import(../condor_syscall_lib,syscall.tmpl)
import(../condor_syscall_lib,switches.special.C)
import(../condor_syscall_lib,switches.prologue)
import(../condor_syscall_lib,switches.epilogue)
import(../condor_syscall_lib,syscall_macros.h)
import(../condor_syscall_lib,switches.remap-SOLARIS.h)
import(../condor_syscall_lib,switches.remap-SOLARIS26.h)
import(../condor_syscall_lib,switches.remap-LINUX.h)
import(../condor_syscall_lib,switches.remap-HPUX.h)
import(../condor_syscall_lib,switches.remap-IRIX.h)
import(../condor_syscall_lib,switches.remap-DUX4.h)

CPP = PreProcessCmd

#if IS_I386_LINUX
STUB_GEN_PLATFORM = GlibCFlag
#elif IS_SOLARIS251
STUB_GEN_PLATFORM = -DSolaris251
#elif IS_SOLARIS26
STUB_GEN_PLATFORM = -DSolaris26
#elif IS_HPUX10
STUB_GEN_PLATFORM = -DHPUX10
#elif IS_IRIX62
STUB_GEN_PLATFORM = -DIRIX62
#endif

STUB_GEN_FLAGS = $(STUB_GEN_PLATFORM) $(DL_EXTRACT) -D$(OS) \
	$(SAVE_SIGSTATE) $(FILE_TABLE) $(CLIP) -Wall

switches.C: syscall.tmpl stub_gen switches.prologue switches.epilogue syscall_macros.h switches.remap-SOLARIS.h switches.remap-SOLARIS26.h switches.remap-LINUX.h switches.remap-HPUX.h switches.remap-IRIX.h switches.remap-DUX4.h linux_kernel_stat.h
	$(CPP) -DSWITCH $(STUB_GEN_FLAGS) syscall.tmpl | \
	./stub_gen -mode switches -p switches.prologue -e switches.epilogue \
	> switches.C

clean::
	rm -f switches.C *.o

CMNT
CMNT Create a replacement for crt0.o to be linked with condor programs.
CMNT N.B. This is done differently than other objects in that we start out
CMNT with a copy of crt0.o, and change the name of "main" to "MAIN".
CMNT
#if IS_HPUX
condor_rt0.o: Crt0 ToUpper
	./ToUpper Crt0 tmp1 _start _START 
	./ToUpper tmp1 tmp2 _data_START _data_start
	./ToUpper tmp2 condor_rt0.o _text_START _text_start
	rm -f tmp1 tmp2
clean::
	rm -f condor_rt0.o
#elif IS_SUN4X_SOLARIS
condor_rt0.o: Crt0 ToUpper
	./ToUpper Crt0 condor_rt0.o main  MAIN
clean::
	rm -f condor_rt0.o
#elif  IS_X86_SOLARIS
condor_rt0.o: Crt0 ToUpper
	./ToUpper Crt0 condor_rt0.o main  MAIN
clean::
	rm -f condor_rt0.o
#elif IS_GLIBC_LINUX && IS_GLIBC21
condor_rt0.o: Crt0 ToUpper
	./ToUpper Crt0 tmp1 main  MAIN
	./ToUpper tmp1 condor_rt0.o __libc_start_MAIN __libc_start_main
clean::
	rm -f condor_rt0.o
#else
condor_rt0.o: Crt0 ToUpper
	./ToUpper Crt0 condor_rt0.o main  MAIN
clean::
	rm -f condor_rt0.o
#endif

clean::
	rm -f c_plus_alloc.o syscall_mode.o

html:

IMPORT_LINKS = ../../config/import_links
import(../condor_c++_util,$(CPP_UTIL_OBJ))
import(../condor_util_lib,$(UTIL_OBJ))
