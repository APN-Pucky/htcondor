#!/s/std/bin/perl

# customize
#
# Perl script that performs platform-specific customization of the
# various files here and creates the proper versions in the
# release_dir. 
#
# Written by Derek Wright <wright@cs.wisc.edu> on 2/27/98
#

&get_platform_defaults();
&customize_config_file( "condor_config.generic",
		       "../release_dir/etc/examples/condor_config.generic" );
&customize_config_file( "condor_config.submit.generic",
		       "../release_dir/etc/examples/condor_config.submit.generic" );
&customize_config_file( "condor_config.root.generic",
		       "../release_dir/etc/examples/condor_config.root.generic" );
&customize_config_file( "condor_config.local.central.manager",
	       "../release_dir/etc/examples/condor_config.local.central.manager" );
&customize_boot_script();


sub get_platform_defaults {
    local( $mach, $os, $rel );
    chop($mach = `uname -m`);
    chop($os = `uname`);
    chop($rel = `uname -r`);
    $console_devs="";
    $needs_kbd=0;
    $_ = $os;
  SWITCH: {
      if(/^Linux/) { 
	  $mail_path="/usr/bin/mail";
	  $os_name="LINUX";
	  $arch_name="INTEL";
	  $ps_path="/bin/ps -auwx";
	  $console_devs="mouse, console";
	  last SWITCH;
      }
      if(/^SunOS/) {
	  $mail_path="/usr/ucb/mail";
	  $ps_path="/usr/ucb/ps -auwx";

	  $_ = $rel;
	  if( /5\.5\.1/ ) {
	      $os_name="SOLARIS251";
	  } elsif( /5\.6/ ) {
	      $os_name="SOLARIS26";
	  } else {
	      $os_name="SOLARIS";
	  }

	  $_ = $mach;
	  if( /^i86pc/ ) {
	      $console_devs="kdmouse, vt00, tty00";
	      $arch_name="INTEL";
	  } elsif( /^sun4u/ ) {
	      $console_devs="mouse, kbd";
	      $arch_name="SUN4u";
	  } else {
	      $console_devs="mouse, kbd";
	      $arch_name="SUN4x";
	  }
	  last SWITCH;
      }
      if(/^HP-UX/) {
	  $console_devs="ps2mouse, ps2kbd, hil1, hil2, hil3, hil4, hil5, hil6, hil7";
	  $mail_path="/bin/mailx";
	  last SWITCH;
      }
      if(/^IRIX6/) {
	  $mail_path="/usr/sbin/mailx";
	  $needs_kbd=1;
	  last SWITCH;
      }
      if(/^IRIX5/) {
	  $mail_path="/usr/sbin/Mail";
	  $needs_kbd=1;
	  last SWITCH;
      }
      if(/^OSF1/)  {
	  $mail_path="/usr/ucb/mailx";
	  $needs_kbd=1;
	  last SWITCH;
      }
  }
}


sub customize_config_file {
    local( $generic, $target ) = @_;
    
    -f $target && unlink( $target );
    
    open( TARGET, ">$target" ) ||
	die "Can't open $target: $!\n";
    open( GENERIC, "<$generic" ) || 
	die "Can't open $generic: $!\n";
    
    print "Configuring $generic ... ";
  LINE: while( <GENERIC> ) {
    SWITCH: {
	if( /^MAIL.*$/ ) { $_ = "MAIL\t\t\t= $mail_path\n"; last SWITCH; }
	if( /^ARCH.*$/ ) { $_ = "ARCH\t\t= $arch_name\n"; last SWITCH; }
	if( /^OPSYS.*$/ ) { $_ = "OPSYS\t\t= $os_name\n"; last SWITCH; }
	if( /^#CONSOLE_DEVICES.*$/ ) {
	   if( $console_devs ) {
	       print TARGET "CONSOLE_DEVICES\t= $console_devs\n";
	   } else {
	       print TARGET $_;
	   }
	   next LINE;
        }
	if( /^DAEMON_LIST.*$/ ) {
	    if( $needs_kbd ) {
		chop($_);
		print TARGET "$_, KBDD\n";
	    } else {
		print TARGET $_;
	    }
	    next LINE;
	}
	print TARGET $_;
    }
  }
    print "done.\n";
    close TARGET;
    close GENERIC;
}


sub customize_boot_script {
    open( GENERIC, "<condor.boot.generic" ) || 
	die "Can't open condor.boot.generic: $!\n";
    open( TARGET, ">../release_dir/etc/examples/condor.boot" ) ||
	die "Can't open target condor.boot: $!\n";

    print "Configuring condor.boot.generic ... ";
    while( <GENERIC> ) {
	if( /^PS.*/ ) {
	    $_ = "PS=\"$ps_path\"\n";
	}
	print TARGET $_;
    }
    print "done.\n";
    close TARGET;
    close GENERIC;
    chmod( 0755, "../release_dir/etc/examples/condor.boot" );
}    
