#!/s/std/bin/perl

# customize
#
# Perl script that performs platform-specific customization of the
# various files here and creates the proper versions in the
# release_dir. 
#
# Written by Derek Wright <wright@cs.wisc.edu> on 2/27/98
#

&get_platform_defaults();
&customize_config_file( "condor_config.generic",
		       "../release_dir/etc/examples/condor_config.generic" );
&customize_config_file( "condor_config.submit.generic",
		       "../release_dir/etc/examples/condor_config.submit.generic" );
&customize_config_file( "condor_config.root.generic",
		       "../release_dir/etc/examples/condor_config.root.generic" );
&customize_init_d_script();


sub get_platform_defaults {
    local( $mach, $os, $rel );
    chop($mach = `uname -m`);
    chop($os = `uname`);
    chop($rel = `uname -r`);
    $mouse_dev="";
    $kbd_dev="";
    $_ = $os;
  SWITCH: {
      if(/^Linux/) { 
	  $mail_path="/usr/bin/mail";
	  $os_name="LINUX";
	  $arch_name="INTEL";
	  $ps_path="/bin/ps -auwx";
	  $mouse_dev="mouse";
	  last SWITCH;
      }
      if(/^SunOS/) {
	  $mail_path="/usr/ucb/mail";
	  $ps_path="/usr/ucb/ps -auwx";

	  $_ = $rel;
	  if( /5\.5\.1/ ) {
	      $os_name="SOLARIS251";
	  } elsif( /5\.6/ ) {
	      $os_name="SOLARIS26";
	  } else {
	      $os_name="SOLARIS";
	  }

	  $_ = $mach;
	  if( /^i86pc/ ) {
	      $mouse_dev="kdmouse";
	      $kbd_dev="vt00";
	      $arch_name="INTEL";
	  } elsif( /^sun4u/ ) {
	      $mouse_dev="mouse";
	      $kbd_dev="kbd";
	      $arch_name="SUN4u";
	  } else {
	      $mouse_dev="mouse";
	      $kbd_dev="kbd";
	      $arch_name="SUN4x";
	  }
	  last SWITCH;
      }
      if(/^HP-UX/) {
	  $mail_path="/bin/mailx";
	  last SWITCH;
      }
      if(/^IRIX6/) {
	  $mail_path="/usr/sbin/mailx";
	  last SWITCH;
      }
      if(/^IRIX5/) {
	  $mail_path="/usr/sbin/Mail";
	  last SWITCH;
      }
      if(/^OSF1/)  {
	  $mail_path="/usr/ucb/mailx";
	  last SWITCH;
      }
  }
}


sub customize_config_file {
    local( $generic, $target ) = @_;

    -f $target && unlink( $target );

    open( TARGET, ">$target" ) ||
	die "Can't open $target: $!\n";
    open( GENERIC, "<$generic" ) || 
	die "Can't open $generic: $!\n";

    print "Configuring $generic ... ";
    LINE: while( <GENERIC> ) {
      SWITCH: {
	  if( /^MAIL.*$/ ) { $_ = "MAIL\t\t\t= $mail_path\n"; last SWITCH; }
	  if( /^ARCH.*$/ ) { $_ = "ARCH\t\t= $arch_name\n"; last SWITCH; }
	  if( /^OPSYS.*$/ ) { $_ = "OPSYS\t\t= $os_name\n"; last SWITCH; }
	  if( /^#KBD_DEVICE.*$/ ) {
	     if( $kbd_dev || $mouse_dev ) {
		 print TARGET "##  These entries allow the startd to monitor keyboard and mouse\n",
		 "##  activity by checking the modification times on special files in\n",
		 "##  /dev.  Activity on these files shows up as \"ConsoleIdle\" time.\n",
		 "##  Just list the file name, without the \"/dev/\" part of the path.\n";
	     }
	     if( $kbd_dev ) {
		 print TARGET "KBD_DEVICE\t= $kbd_dev\n";
	     } else { 
		 print TARGET "#KBD_DEVICE\t= \n";		 
	     }
	     if( $mouse_dev ) {
		 print TARGET "MOUSE_DEVICE\t= $mouse_dev\n";
	     } else {
		 print TARGET "#MOUSE_DEVICE\t= \n";
	     }
	     next LINE;
	 }
      }
	print TARGET "$_";
    }
    print "done.\n";
    close TARGET;
    close GENERIC;
}


sub customize_init_d_script {
    open( GENERIC, "<condor.init.d.generic" ) || 
	die "Can't open condor.init.d.generic: $!\n";
    open( TARGET, ">../release_dir/etc/examples/condor.init.d.generic" ) ||
	die "Can't open target condor.init.d.generic: $!\n";

    print "Configuring condor.init.d.generic ... ";
    while( <GENERIC> ) {
	if( /^PS.*/ ) {
	    $_ = "PS=\"$ps_path\"\n";
	}
	print TARGET $_;
    }
    print "done.\n";
    close TARGET;
    close GENERIC;
}    
