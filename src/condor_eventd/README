                      Event Daemon Specification

PARAMETERS
----------

  EVENTD_LOG - log file
  EVENTD_DEBUG - debug logging level; default is D_ALWAYS
  EVENTD_INTERVAL - number of seconds between collector queries to
    determine pool state; default is 15 minutes
  EVENTD_MAX_PREPARATION - number of seconds before a scheduled event
    when the eventd should start polling; if 0 (default), eventd
    always polls 
  EVENT_LIST - list of macro names which define events
  EVENTD_SHUTDOWN_SLOW_START_INTERVAL - number of seconds between each
    machine startup after a shutdown event; default is 0
  EVENTD_SHUTDOWN_CLEANUP_INTERVAL - number of seconds between each
    check for old shutdown configs in the pool; default is one hour

For example:

  EVENTD_LOG = $(LOG)/EventdLog
  EVENTD_DEBUG = D_FULLDEBUG
  EVENTD_INTERVAL = 900
  EVENT_LIST = TestEvent, TestEvent2
  TestEvent = SHUTDOWN W 16:00 3600 2 TestEventConstraint TestEventRank
  TestEvent = SHUTDOWN F 14:00 1200 2 TestEventConstraint2 TestEventRank
  TestEventConstraint = (Machine == "froth.cs.wisc.edu")
  TestEventConstraint2 = (Machine == "perdita.cs.wisc.edu")
  TestEventRank = (0 - ImageSize)
  EVENTD_SHUTDOWN_SLOW_START_INTERVAL = 0

In this example, the "TestEvent" is a SHUTDOWN type event, which
specifies that all machines whose startd ads match the constraint
(Machine == "froth.cs.wisc.edu") should be shutdown for 3600 seconds
starting at 16:00 every Wednesday, and no more than 2 Mb/s of
bandwidth should be used to prepare for the shutdown event.

Additional event types may be defined later.


ALGORITHM
---------

Every EVENTD_INTERVAL seconds, for each defined event, the event
daemon computes an estimate of the time required to complete or
prepare for the event.  If (time required < (event start time -
EVENTD_INTERVAL - current time)), then the event daemon activates the
event.


SHUTDOWN EVENTS
---------------

Format: SHUTDOWN DAY TIME DURATION BANDWIDTH CONSTRAINT RANK
  example: SHUTDOWN MTWRFSU 04:00 3600 5 MyConst MyRank
  example: SHUTDOWN MTWRF 23:00 3600 20 MyConst MyRank

To determine the estimate of the time required to complete a SHUTDOWN
event, the ImageSize values for all running standard universe jobs are
totalled and then divided by the maximum bandwidth specified for this
event.

When a SHUTDOWN event is activated, the eventd contacts all startds
which match the given constraint and inserts the following into their
configuration:

  EndDownTime = 913066770 
  Shutdown = (CurrentTime < EndDownTime)
  START : ($(START)) && ($(Shutdown) == False)
  STARTD_EXPRS = $(STARTD_EXPRS), EndDownTime

EndDownTime is set to be (event start time + event duration +
interval), where interval is incremented for each machine according to
EVENTD_SHUTDOWN_SLOW_START_INTERVAL.  The protocol for changing
configurations is documented in condor_daemon_core.V6/README.config.

The eventd then sends a VACATE_CLAIM command to the first startd in
the list, computes the time required for that startd to vacate, and
sets a timer to wake up in that amount of time.

Each time the timer goes off, the eventd:
  - rebuilds its list of startds to be shutdown
  - contacts any startds which it failed to contact previously and
    modifies their configuration as above
  - sends a VACATE_CLAIM to the first claimed startd in the list
  - re-sets the timer

As an optimization, if the time required for a vacate is 0 (i.e., a
vanilla job), the eventd simply continues down the list.

When the list is empty, the eventd checks periodically for new startds
until the event period is over.

The motivation for graceful shutdown events is to avoid a huge burst
of checkpoints when many machines are shutdown, which often results in
checkpoint failures.  The graceful shutdown processing described can
make no guarantees, however.  The bandwidth may not be available to
checkpoint according to the schedule, or new startds could enter the
pool and start running jobs while the shutdown is occurring.  The
eventd will notice the new startds at the next interval and add them
to the shutdown list, but this may push the schedule past the
deadline.  The event may be scheduled a little early to allow for some
schedule slippage as needed.

It may be appropriate to schedule separate shutdown events per subnet
or checkpoint server domain, especially if multiple checkpoint servers
are deployed.  This will allow the eventd to manage bandwidth per
subnet or checkpoint server domain.

The eventd is stateless.  If it is restarted in the middle of a
shutdown event, it will re-compute the time to complete the event,
re-activate the event when it realizes that the deadline is
approaching, configure those startds which don't yet have an
EndDownTime set, and continue the shutdowns.  Note that the value of
the slow start interval counter is lost (reset to zero) on restarts.

The modified startd configuration is persistent, so if the startd
restarts, it will remain in the shutdown state until EndDownTime
arrives.  As mentioned above, if a startd starts up during a shutdown
event, the eventd will notice it and place it in the shutdown state.

While periodically computing the time estimate for SHUTDOWN events,
the eventd cleans up any old SHUTDOWN configurations found (i.e., for
which EndDownTime is less than CurrentTime).


ISSUES
------

The eventd does not yet do anything to gracefully shutdown schedds.
One possible solution is to gracefully shutdown schedds after we have
configured all of the startds to be in Shutdown mode but before we
send any VACATE_CLAIM commands.  The event daemon could compute the
time needed to gracefully shutdown each schedd by querying startds
with the appropriate RemoteUser value.  (This will not work if a user
submits from more than one schedd, though.)  It would be nice to
shutdown one job at a time.  This will be addressed further at a
future date.

Since time_t is used in all cases, timezones should not be an issue.
The timezone in effect where the eventd is running determines the
timing of events.  However, the eventd is only as precise as the
synchronization of the clocks of the machines in the Condor pool.  No
effort is made to correct for poorly synchronized clocks.
