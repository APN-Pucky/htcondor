SRC_DIR = $(SRC_TREE)/condor_classad.V6

/* select required features */
#include "classad_features.h"


C_PLUS_FLAGS 		= -Wall $(STD_C_PLUS_FLAGS)
CFLAGS 			= -Wall $(STD_C_FLAGS)


/* The basic classad source and object files */
CLASSAD_SRC_0 		= debug.C lexer.C lexerSource.C source.C operators.C attrrefs.C fnCall.C   \
                      literals.C exprTree.C classad.C exprList.C value.C \
                      instantiations.C sink.C matchClassad.C condorUtil.C      \
                      util.C xmlLexer.C xmlSink.C xmlSource.C cclassad.C
CLASSAD_OBJ_0 		= debug.o lexer.o lexerSource.o source.o operators.o attrrefs.o fnCall.o   \
                      literals.o exprTree.o classad.o exprList.o value.o \
                      instantiations.o sink.o  matchClassad.o condorUtil.o     \
                      util.o xmlLexer.o xmlSink.o xmlSource.o cclassad.o


/* Are collections required? */
#if defined(COLLECTIONS)
CLASSAD_SRC_1		= $(CLASSAD_SRC_0) view.C collection.C collectionBase.C   \
                      collectionServer.C collectionClient.C transaction.C     \
                      query.C remoteQuery.C coll-comm-inst.C coll-serv-inst.C \
                      coll-client-inst.C indexfile.C 
CLASSAD_OBJ_1		= $(CLASSAD_OBJ_0) view.o collection.o collectionBase.o   \
                      collectionServer.o collectionClient.o transaction.o     \
                      query.o remoteQuery.o	coll-comm-inst.o coll-serv-inst.o \
                      coll-client-inst.o indexfile.o
#else
CLASSAD_SRC_1		= $(CLASSAD_SRC_0)
CLASSAD_OBJ_1		= $(CLASSAD_OBJ_0)
#endif


/* Are experimental features required? */
#if defined(EXPERIMENTAL)
CLASSAD_SRC_2		= $(CLASSAD_SRC_1) rectangle.C intervalTree.C compress.C\
						queryProcessor.C exp-inst.C
CLASSAD_OBJ_2		= $(CLASSAD_OBJ_1) rectangle.o intervalTree.o compress.o\
						queryProcessor.o exp-inst.o
#else
CLASSAD_SRC_2		= $(CLASSAD_SRC_1)
CLASSAD_OBJ_2		= $(CLASSAD_OBJ_1)
#endif

#if defined(CLASSAD_DEPRECATED)
CLASSAD_SRC_3		= $(CLASSAD_SRC_2) classad_deprecated.C
CLASSAD_OBJ_3		= $(CLASSAD_OBJ_2) classad_deprecated.o

#else
CLASSAD_SRC_3		= $(CLASSAD_SRC_2)
CLASSAD_OBJ_3		= $(CLASSAD_OBJ_2)
#endif


SRC = $(CLASSAD_SRC_3) ../condor_c++_util/condor_attributes.C
OBJ = $(CLASSAD_OBJ_3) ../condor_c++_util/condor_attributes.o


LIB_BASE =  ./libclassad.a ../condor_c++_util/cplus_lib.a \
      ../condor_util_lib/util_lib.a \
      ../condor_c++_util/cplus_lib.a ../condor_util_lib/util_lib.a \
      ../condor_util_lib/util_lib.a ../condor_sysapi/libsysapi.a \
      $(STLPORT_LIB)

#if defined(CLASSAD_DEPRECATED)
LIB = $(LIB_BASE) $(IO_LIB) $(SECURITY_LIB) $(CPLUS_LIB) $(SECURITY_LIB) 
#else
LIB = $(LIB_BASE)
#endif

/* the main condor library target */
all_target(libclassad.a classad_functional_tester classad_unit_tester classad_version test_xml extra_tests)
library_target(libclassad.a,$(OBJ))

release:: all

/* template instantiations go in here */
template_inst( instantiations.C, instantiations.o ) 	/* main classad insts */
template_inst( test_instantiations.C, test_instantiations.o ) /* test program insts */
template_inst( coll-comm-inst.C, coll-comm-inst.o ) 	/* common collection  */
template_inst( coll-serv-inst.C, coll-serv-inst.o ) 	/* collection server  */
template_inst( coll-client-inst.C,coll-client-inst.o) 	/* collection client*/
template_inst( exp-inst.C, exp-inst.o )					/* experimental */

/* Standalone distribution of classads/collections */
DIST_VERSION = 0.9.9
DISTRIBUTION_DIR = classads-$(DIST_VERSION)

DIST_FILES = attrrefs.C attrrefs.h classad.C classad.h					\
classad_functional_tester.C classad_functional_tester.h					\
classad_unit_tester.C classad_version.C collection.C collection.h		\
collectionBase.C collectionBase.h common.h classadErrno.h				\
classadItor.h cxi.C debug.C debug.h exprList.C exprList.h exprTree.C	\
exprTree.h extra_tests.C fnCall.C fnCall.h indexfile.h indexfile.C		\
instantiations.C lexer.C lexer.h lexerSource.C lexerSource.h			\
literals.C literals.h matchClassad.C matchClassad.h operators.C			\
operators.h query.C query.h sample.C shared.C sink.C sink.h source.C	\
source.h test_instantiations.C test_xml.C tests.txt transaction.C		\
transaction.h util.C util.h value.C value.h view.C view.h xmlLexer.C	\
xmlLexer.h xmlSink.h xmlSink.C xmlSource.h xmlSource.C					\
classad_distribution.h cclassad.C cclassad.h classad_stl.h LICENSE		\
README CHANGELOG configure functional_tests.txt ClassAd.swg

WIN32_FILES = win32/classad_dist.dsw						\
win32/classad_functional_tester.dep							\
win32/classad_functional_tester.dsp							\
win32/classad_functional_tester.mak win32/classad_lib.dep	\
win32/classad_lib.dsp win32/classad_lib.mak					\
win32/classad_unit_tester.dep win32/classad_unit_tester.dsp	\
win32/classad_unit_tester.mak win32/make.bat

dist: $(DIST_FILES)
	cp build_external build_classads-$(DIST_VERSION)
	chmod 755 build_classads-$(DIST_VERSION)
	chmod 664 $(DIST_FILES)
	chmod 775 configure
	chmod 664 $(WIN32_FILES)
	chmod 775 win32/make.bat
	rm -rf $(DISTRIBUTION_DIR) *.gz
	mkdir $(DISTRIBUTION_DIR)
	mkdir $(DISTRIBUTION_DIR)/win32
	mkdir -p $(DISTRIBUTION_DIR)/perl/lib/ClassAd
	mkdir $(DISTRIBUTION_DIR)/perl/t
	cp $(DIST_FILES) $(DISTRIBUTION_DIR)
	cp makefile-dist $(DISTRIBUTION_DIR)/Makefile
	cp $(WIN32_FILES) $(DISTRIBUTION_DIR)/win32
# Originally this line was simpler, but it ended in an asterisk,
# and that caused condor_imake problems.
	find $(DISTRIBUTION_DIR)/win32/ -type f | xargs unix2dos
	cp perl/Simple.pm $(DISTRIBUTION_DIR)/perl/lib/ClassAd
	cp perl/basic.t $(DISTRIBUTION_DIR)/perl/t
	tar cf $(DISTRIBUTION_DIR).tar $(DISTRIBUTION_DIR)
	gzip $(DISTRIBUTION_DIR).tar
	chmod 664 $(DISTRIBUTION_DIR).tar.gz

/* Rule to make documentation */
doc: html

#ifdef ENABLE_SHARED_LIBRARY_FUNCTIONS
shared:
	g++ -fPIC -shared -o libshared.so shared.C
#endif

/* Also depends on several header files, but I am ignoring that for now */
html_target( documentation )

clean::
	rm -f -r *.o *.gz html

/* The Classad eXpression Interpreter */
#ifdef ENABLE_SHARED_LIBRARY_FUNCTIONS
LDFLAGS =  -Xlinker --export-dynamic -ldl
#endif

c_plus_target (cxi, cxi.o, $(LIB))
c_plus_target (test_classads, test_classads.o test_instantiations.o, $(LIB))
c_plus_target (classad_functional_tester, classad_functional_tester.o test_instantiations.o, $(LIB))
c_plus_target (classad_unit_tester, classad_unit_tester.o, $(LIB))
c_plus_target (classad_version, classad_version.o, $(LIB))
c_plus_target (test_xml, test_xml.o, $(LIB))
c_plus_target (extra_tests, extra_tests.o, $(LIB))
c_plus_target (sample, sample.o, $(LIB))
c_plus_target (man_cache_test, man_cache_test.o, $(LIB))

