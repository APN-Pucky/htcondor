DESTDIR = /usr/include

# This include will redefine DESTDIR, if Makefile.config exists
include Makefile.config

LD_FLAGS = $(EXTRA_LD_FLAGS) -L. -l$(LIB_LINK_NAME) $(STLPORT_LIB)

all:: $(LIB_NAME) classad_functional_tester classad_unit_tester classad_version cxi extra_tests test_xml sample

LIB_INSTALL = $(DESTDIR)/lib
BIN_INSTALL = $(DESTDIR)/bin
INCLUDE_INSTALL = $(DESTDIR)/include

CPlusPlus = g++
BASE_C_PLUS_FLAGS = $(STLPORT_FLAGS) $(EXTRA_C_PLUS_FLAGS) -Wall -Wuninitialized -O -g -DCLASSAD_DISTRIBUTION 
INST_C_PLUS_FLAGS = $(BASE_C_PLUS_FLAGS) -w
C_PLUS_FLAGS = $(TEMPLATE_FLAGS) $(BASE_C_PLUS_FLAGS)
PURIFY = purify -g++=yes -chain-length=35 $(CPlusPlus)

.C.o:
	$(CPlusPlus) $(C_PLUS_FLAGS) -c $<

LIB_OBJ = attrrefs.o classad.o collection.o collectionBase.o debug.o	\
exprList.o exprTree.o fnCall.o indexfile.o lexer.o lexerSource.o		\
literals.o matchClassad.o operators.o query.o sink.o source.o			\
transaction.o util.o value.o view.o xmlLexer.o xmlSink.o xmlSource.o	\
cclassad.o $(INSTANTIATIONS_O)

HEADER_FILES = $(shell \ls *.[h])

PERL_ARCHLIB = $(shell perl -MConfig -e 'print "$$Config{archlib}\n"')
.PHONY: perl
perl: all perl/lib/$(PERL_ARCHNAME)/ClassAd.so

perl/lib/$(PERL_ARCHNAME)/ClassAd.so: $(LIB_OBJ) ClassAd.swg
	swig -v -Wall -c++ -perl -proxy -o classad_wrap.C ClassAd.swg
	g++ -fno-implicit-templates -g -DCLASSAD_DISTRIBUTION -I$(PERL_ARCHLIB)/CORE -c classad_wrap.C
	g++ -shared $(LIB_OBJ) classad_wrap.o -o ClassAd.so
	mkdir -p perl/lib/ClassAd
	mv ClassAd.so ClassAd.pm perl/lib/

$(LIB_NAME):  $(LIB_OBJ)
	rm -f  $(LIB_NAME)
	ar vrs $(LIB_NAME)  $(LIB_OBJ)

instantiations.o:   instantiations.C
	$(CPlusPlus) $(INST_C_PLUS_FLAGS) -c instantiations.C -o instantiations.o

test_instantiations.o:   test_instantiations.C
	$(CPlusPlus) $(INST_C_PLUS_FLAGS) -c test_instantiations.C -o test_instantiations.o

cxi: cxi.o $(LIB_NAME)
	$(CPlusPlus) -o cxi cxi.o $(LD_FLAGS)

classad_functional_tester: classad_functional_tester.o $(LIB_NAME) $(TEST_INSTANTIATIONS_O)
	$(CPlusPlus) -o classad_functional_tester classad_functional_tester.o $(TEST_INSTANTIATIONS_O) $(LD_FLAGS)

classad_unit_tester: classad_unit_tester.o $(LIB_NAME)
	$(CPlusPlus) -o classad_unit_tester classad_unit_tester.o $(LD_FLAGS)

classad_version: classad_version.o $(LIB_NAME)
	$(CPlusPlus) -o classad_version classad_version.o $(LD_FLAGS)

test_xml: test_xml.o $(LIB_NAME)
	$(CPlusPlus) -o test_xml test_xml.o $(LD_FLAGS)

extra_tests: extra_tests.o $(LIB_NAME)
	$(CPlusPlus) -o extra_tests extra_tests.o $(LD_FLAGS)

extra_test.pure: extra_tests.o $(LIB_NAME)
	$(PURIFY) -o extra_tests.pure extra_tests.o $(LD_FLAGS)

sample: sample.o $(LIB_NAME)
	$(CPlusPlus) -o sample sample.o $(LD_FLAGS)

shared: shared.C
	$(CPlusPlus) -fPIC -shared -o libshared.so shared.C

install:: $(LIB_NAME) classad_functional_tester classad_unit_tester classad_version
	mkdir -p $(LIB_INSTALL)
	mkdir -p $(BIN_INSTALL)
	mkdir -p $(INCLUDE_INSTALL)
	cp $(LIB_NAME)  $(LIB_INSTALL)
	cp classad_functional_tester $(BIN_INSTALL)
	cp classad_unit_tester $(BIN_INSTALL)
	cp classad_version $(BIN_INSTALL)
	cp $(HEADER_FILES) $(INCLUDE_INSTALL)

clean: tidy
	rm -f classad_functional_tester classad_unit_tester classad_version
	rm -f test_xml cxi sample $(LIB_NAME)
	rm -f perl/lib/*.pm perl/lib/*.so
tidy:
	rm -f *.o *~ *.bak

