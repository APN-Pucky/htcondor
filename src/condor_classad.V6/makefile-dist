DESTDIR = /usr/include

# This include will redefine DESTDIR, if Makefile.config exists
include Makefile.config

LD_FLAGS = $(EXTRA_LD_FLAGS) -L. -lclassad

all:: libclassad.a classad_functional_tester classad_unit_tester classad_version cxi extra_tests test_xml sample

LIB_INSTALL = $(DESTDIR)/lib
BIN_INSTALL = $(DESTDIR)/bin
INCLUDE_INSTALL = $(DESTDIR)/include

CPlusPlus = g++
C_PLUS_FLAGS = $(EXTRA_C_PLUS_FLAGS) -Wall -g -DCLASSAD_DISTRIBUTION 
INST_C_PLUS_FLAGS = $(C_PLUS_FLAGS) -w
NO_INST_C_PLUS_FLAGS = -fno-implicit-templates $(C_PLUS_FLAGS)
PURIFY = purify -g++=yes -chain-length=35 $(CPlusPlus)

.C.o:
	$(CPlusPlus) $(NO_INST_C_PLUS_FLAGS) -c $<

LIB_OBJ = attrrefs.o classad.o collection.o collectionBase.o debug.o	\
exprList.o exprTree.o fnCall.o indexfile.o lexer.o lexerSource.o		\
literals.o matchClassad.o operators.o query.o sink.o source.o			\
transaction.o util.o value.o view.o xmlLexer.o xmlSink.o xmlSource.o	\
cclassad.o instantiations.o

HEADER_FILES = $(shell \ls *.[h])

libclassad.a:  $(LIB_OBJ)
	rm -f  libclassad.a
	ar vrs libclassad.a  $(LIB_OBJ)

instantiations.o:   instantiations.C
	$(CPlusPlus) $(INST_C_PLUS_FLAGS) -c instantiations.C -o instantiations.o

test_instantiations.o:   test_instantiations.C
	$(CPlusPlus) $(INST_C_PLUS_FLAGS) -c test_instantiations.C -o test_instantiations.o

cxi: cxi.o libclassad.a
	$(CPlusPlus) -o cxi cxi.o $(LD_FLAGS)

classad_functional_tester: classad_functional_tester.o libclassad.a test_instantiations.o
	$(CPlusPlus) -o classad_functional_tester classad_functional_tester.o test_instantiations.o $(LD_FLAGS)

classad_unit_tester: classad_unit_tester.o libclassad.a
	$(CPlusPlus) -o classad_unit_tester classad_unit_tester.o $(LD_FLAGS)

classad_version: classad_version.o libclassad.a
	$(CPlusPlus) -o classad_version classad_version.o $(LD_FLAGS)

test_xml: test_xml.o libclassad.a
	$(CPlusPlus) -o test_xml test_xml.o $(LD_FLAGS)

extra_tests: extra_tests.o libclassad.a
	$(CPlusPlus) -o extra_tests extra_tests.o $(LD_FLAGS)

extra_test.pure: extra_tests.o libclassad.a
	$(PURIFY) -o extra_tests.pure extra_tests.o $(LD_FLAGS)

sample: sample.o libclassad.a
	$(CPlusPlus) -o sample sample.o $(LD_FLAGS)

shared: shared.C
	$(CPlusPlus) -fPIC -shared -o libshared.so shared.C

install:: libclassad.a classad_functional_tester classad_unit_tester classad_version
	mkdir -p $(LIB_INSTALL)
	mkdir -p $(BIN_INSTALL)
	mkdir -p $(INCLUDE_INSTALL)
	cp libclassad.a  $(LIB_INSTALL)
	cp classad_functional_tester $(BIN_INSTALL)
	cp classad_unit_tester $(BIN_INSTALL)
	cp classad_version $(BIN_INSTALL)
	cp $(HEADER_FILES) $(INCLUDE_INSTALL)

clean: tidy
	rm -f classad_functional_tester classad_unit_tester classad_version
	rm -f test_xml cxi sample libclassad.a
tidy:
	rm -f *.o *~ *.bak

