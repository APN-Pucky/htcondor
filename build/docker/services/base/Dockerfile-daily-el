# This is the base image for HTCondor; no role-specific config
ARG EL

FROM centos:${EL}

# "ARG EL" needs to be here again because the previous instance has gone out of scope.
ARG EL
ARG BUILDDATE
ARG SERIES
ARG SUFFIX

# https://label-schema.org/rc1
LABEL org.label-schema.name="HTCondor RHEL-compatible base image (daily build)" \
      org.label-schema.vendor="HTCondor" \
      org.label-schema.license="Apache-2.0" \
      org.label-schema.build-date="${BUILDDATE}"

# Unset these from parent
LABEL org.opencontainers.image.created="" \
      org.opencontainers.image.licenses="" \
      org.opencontainers.image.title="" \
      org.opencontainers.image.vendor="" \
      build-date="" \
      io.buildah.version="" \
      license="" \
      name="" \
      vendor=""

# Ensure that the 'condor' UID/GID matches across containers
RUN groupadd -g 64 -r condor && \
    useradd -r -g condor -d /var/lib/condor -s /sbin/nologin \
      -u 64 -c "Owner of HTCondor Daemons" condor

# EPEL is needed for supervisor
# openssh-clients and openssh-server are for condor_ssh_to_job
RUN \
    yum -y update; \
    ## ^^ ignore errors; some packages (like "filesystem") might fail to update in a container environment \
    yum -y install epel-release && \
    if [ 7 -eq ${EL} ]; then \
        yum -y install yum-plugin-priorities; \
    elif [ 8 -eq ${EL} ]; then \
        yum -y install dnf-plugins-core && \
        (dnf config-manager --set-enabled powertools || dnf config-manager --set-enabled PowerTools) && \
        yum -y erase dnf-plugins-core; \
    fi && \
    \
    yum install -y https://research.cs.wisc.edu/htcondor/repo/${SERIES}/htcondor-release-current.el${EL}.noarch.rpm  && \
    rpm --import /etc/pki/rpm-gpg/*  && \
    \
    yum -y install --enablerepo=htcondor-daily condor supervisor openssh-clients openssh-server && \
    rpm -q condor supervisor openssh-clients openssh-server && \
    yum clean all && \
    rm -rf /var/cache/yum/*

# Create passwords directories for token or pool password auth.
#
# Only root needs to know the pool password but other condor daemons
# need access to the tokens.
#
# TODO: May not be necessary in newer HTCondor RPMs
RUN \
    install -m 0700 -o root -g root -d /etc/condor/passwords.d && \
    install -m 0700 -o condor -g condor -d /etc/condor/tokens.d

# We use supervisor for two reasons:
# - As of 8.9.4, the master can't run as pid 1 because it immediately dies
#   trying to send a signal to itself.
# - We want something to restart the master in case it dies.
#
# A wrapper script is used to copy configs from a config volume mounted
# at /root/config

COPY base/supervisord.conf /etc/supervisord.conf
COPY base/condor/*.conf /etc/condor/config.d/
COPY base/start.sh base/update-config base/update-secrets /
COPY base/pre-exec.sh /root/config/pre-exec.sh

CMD ["/bin/bash", "-x", "/start.sh"]

