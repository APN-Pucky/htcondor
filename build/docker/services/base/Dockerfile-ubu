# This is the base image for HTCondor; no role-specific config
ARG UBU

FROM ubuntu:${UBU}

# "ARG UBU" needs to be here again because the previous instance has gone out of scope.
ARG UBU
ARG BUILDDATE
ARG VERSION
ARG SUFFIX
ARG SERIES

# https://label-schema.org/rc1
LABEL org.label-schema.name="HTCondor Ubuntu base image" \
      org.label-schema.vendor="HTCondor" \
      org.label-schema.license="Apache-2.0" \
      org.label-schema.build-date="${BUILDDATE}"

# install OS packages
RUN \
    apt-get update -q && \
    apt-get install -qy gnupg2 less ssh supervisor vim-tiny wget  && \
    rm -rf /var/lib/apt/lists/* /var/cache/apt/*  && \
    :

# Ensure that the 'condor' UID/GID matches across containers
RUN groupadd -g 64 -r condor && \
    useradd -r -g condor -d /var/lib/condor -s /sbin/nologin \
      -u 64 -c "Owner of HTCondor Daemons" condor

# ssh is for condor_ssh_to_job
RUN \
    export DEBIAN_FRONTEND=noninteractive  && \
    if [ -z "${SERIES}" ]; then \
        [ -n "${VERSION}" ] && SERIES=${VERSION%.*}; \
    fi; \
    case ${UBU} in  \
        18.04) nickname=bionic  ;; \
        20.04) nickname=focal  ;; \
        *) echo "don't know Ubuntu version ${UBU}"; exit 1  ;; \
    esac;  \
    wget -qO - https://research.cs.wisc.edu/htcondor/ubuntu/HTCondor-Release.gpg.key | apt-key add -  && \
    echo "deb http://research.cs.wisc.edu/htcondor/ubuntu/${SERIES}/${nickname} ${nickname} contrib" >> /etc/apt/sources.list  && \
    echo "deb-src http://research.cs.wisc.edu/htcondor/ubuntu/${SERIES}/${nickname} ${nickname} contrib" >> /etc/apt/sources.list  && \
    apt-get update -q && \
    if [ -n "${VERSION}" ]; then \
        version_release=$(apt-cache madison htcondor | grep -F ${VERSION} | awk '/Packages/ {print $3; exit}')  && \
        # ^^ get the version-release string because unlike RHEL I can't install with just the version \
        apt-get install -qy htcondor=$version_release libclassad12=$version_release; \
        # ^^ I have to explicitly specify the version-release of libclassad because otherwise it will try to install the latest and barf because it doesn't work with a different version of condor. \
    else \
        apt-get install -qy htcondor; \
    fi && \
    rm -rf /var/lib/apt/lists/* /var/cache/apt/*  && \
    :

# Create passwords directories for token or pool password auth.
#
# Only root needs to know the pool password but other condor daemons
# need access to the tokens.
#
# In the future, the packages will take care of this step.
RUN \
    install -m 0700 -o root -g root -d /etc/condor/passwords.d && \
    install -m 0700 -o condor -g condor -d /etc/condor/tokens.d

# We use supervisor for two reasons:
# - As of 8.9.4, the master can't run as pid 1 because it immediately dies
#   trying to send a signal to itself.
# - We want something to restart the master in case it dies.
#
# A wrapper script is used to copy configs from a config volume mounted
# at /root/config

RUN mkdir /root/config

COPY base/supervisord.conf /etc/supervisord.conf
COPY base/condor/*.conf /etc/condor/config.d/
COPY base/start.sh base/update-config base/update-secrets /
COPY base/pre-exec.sh /root/config/pre-exec.sh

CMD ["/bin/bash", "-x", "/start.sh"]

