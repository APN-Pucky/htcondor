# This is a minicondor image; runs all the daemons for a single-node pool
# Designed for interactive use and experimentation;
# also includes man pages and htcondor-restd running on port 8080.

# Become the "submituser" user to submit jobs.
ARG BASETAG

FROM htcondor/base:${BASETAG}

ARG BUILDDATE

# https://label-schema.org/rc1
LABEL org.label-schema.name="HTCondor RHEL-compatible minicondor (daily build)" \
      org.label-schema.build-date="${BUILDDATE}"

# perl is needed for condor_run. Reinstalling condor to get the man pages too.
# git and flask are needed for the restd; jq is too useful not to include.
RUN \
    yum install -y perl  && \
    yum reinstall -y --setopt=tsflags='' --enablerepo=htcondor-daily "*condor*" && \
    yum install -y --setopt=tsflags='' man-db && \
    yum install -y --setopt=tsflags='' --enablerepo=htcondor-daily minicondor && \
    \
    yum install -y git-core python3-flask jq &&  \
    \
    rpm -q perl condor man-db minicondor jq && \
    (rpm -q git || rpm -q git-core) && \
    (rpm -q python3-flask || rpm -q python36-flask) && \
    yum clean all && \
    rm -rf /var/cache/yum/*

RUN useradd restd
RUN useradd submituser

# flask_restful is not available in yum repos
RUN pip-3 install flask_restful
RUN pip-3 install git+https://github.com/htcondor/htcondor-restd.git@master\#egg=htcondor-restd

COPY mini/supervisord.conf /etc/supervisord.conf
COPY mini/condor_restd.sh /usr/local/bin/condor_restd.sh
COPY mini/start.sh /start.sh

RUN chmod +x \
    /start.sh \
    /usr/local/bin/condor_restd.sh

# Remove files from base image that are unused
RUN rm -f \
    /update-config \
    /update-secrets \
    /etc/condor/config.d/01-security.conf

EXPOSE 8080

CMD ["/start.sh"]

