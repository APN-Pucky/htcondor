#!/bin/bash

tmpdir=tmp.$$
default_pattern_file=tmpfile.$$

if [ "$1" = "" -o "$2" = "" ] ; then
  echo "Usage:" `basename $0` "<library tarball> <release directory> [<pattern file>]"
  exit 1
fi
if [ ! -d $2 ] ; then
  echo "$2 isn't a directory!"
  exit 1
fi
if [ "$3" != "" ] ; then
  pattern_file=$3
else
  pattern_file=$default_pattern_file
  echo . >$pattern_file
fi
tarball=`echo $1 | sed 's|^\([^/]\)|'$PWD'/\1|'`
release_dir=$2

mkdir $tmpdir
for lib in `find $release_dir -perm -u=x -type f -exec ldd '{}' ';' | \
    grep '[^ ] => [^ n]' | sed 's/[^>]*> \([^ ]*\).*/\1/' | sort -u | grep -f $pattern_file` ;
do
  ln -s $lib $tmpdir
done
cd $tmpdir
tar zhcvf $tarball *  
cd ..
rm -rf $tmpdir $default_pattern_file
