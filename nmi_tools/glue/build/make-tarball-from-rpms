#!/bin/bash
# This command takes a directory of HTCondor RPMs and creates a tarball
# Named externals are download and extracted from existing repositories
#
if [ $# -ne 1 ]; then
    echo 'Error: missing argument'
    echo "Usage: $(basename $0) RPMs-directory"
    exit 1
fi
rpmdir=$1
if [ ! -d $rpmdir ]; then
    echo "Error: $rpmdir is not a directory"
    echo "Usage: $(basename $0) RPMs-directory"
    exit 1
fi

cmd_dir=$(dirname $0)

mkdir tarball

for file in $rpmdir/*.rpm; do
    if [[ $file == *.src.rpm ]]; then
        # Skip src RPM
        echo Skipping $file
    elif [[ $file == *-debuginfo-* ]]; then
        # Skip debug information
        echo Skipping $file
    elif [[ $file == */python2-* ]]; then
        # Skip debug information
        echo Skipping $file
    elif [[ $file == *-credmon-oauth-* ]]; then
        # Skip debug information
        echo Skipping $file
    else
        eval $(perl -e "(\$package, \$version, \$release, \$dist, \$arch) = '$file' =~ m:^.*/(.*)-([0-9][0-9.]*)-([0-9][0-9.]*)\.([^.]+)\.([^.]+)\.rpm$:; print \"package=\$package version=\$version release=\$release dist=\$dist arch=\$arch\";")
        echo ======= $package-$version-$release.$dist.$arch.rpm =======
        echo $package-$version-$release.$dist.$arch.rpm >> tarball/Manifest.txt
        rpm2cpio $rpmdir/$package-$version-$release.$dist.$arch.rpm | (cd tarball; cpio -imd)
    fi
done

if [[ $dist == amzn2 ]]; then
    arch_dist="${arch}_AmazonLinux2"
elif [[ $dist == el7 ]]; then
    arch_dist="${arch}_CentOS7"
elif [[ $dist == el8 ]]; then
    arch_dist="${arch}_CentOS8"
elif [[ $dist == fc32 ]]; then
    arch_dist="${arch}_Fedora32"
fi

# Repack the testing tarball
rm -rf condor_tests-*
tar xfp tarball/usr/lib64/condor/condor_tests-$version.tar.gz
rm tarball/usr/lib64/condor/condor_tests-$version.tar.gz
mv condor_tests-* condor_tests-$version-$release-$arch_dist
(cd condor_tests-$version-$release-$arch_dist; chmod a+x $(file $(find -type f)|grep 'executable'|sed -e s/:.*//))
$cmd_dir/set-tarball-rpath condor_tests-$version-$release-$arch_dist
tar cfz condor_tests-$version-$release-$arch_dist.tar.gz condor_tests-$version-$release-$arch_dist
rm -rf condor_tests-$version-$release-$arch_dist

# Move configuration files back to example directory
mv tarball/etc/condor/config.d/* tarball/usr/share/doc/condor-$version/examples/

el7externals="blahp \
    boost169-python3 \
    condor-boinc \
    globus-callout \
    globus-common \
    globus-ftp-client \
    globus-ftp-control \
    globus-gass-transfer \
    globus-gram-client \
    globus-gram-protocol \
    globus-gsi-callback \
    globus-gsi-cert-utils \
    globus-gsi-credential \
    globus-gsi-openssl-error \
    globus-gsi-proxy-core \
    globus-gsi-proxy-ssl \
    globus-gsi-sysconfig \
    globus-gss-assist \
    globus-gssapi-error \
    globus-gssapi-gsi \
    globus-io \
    globus-openssl-module \
    globus-rsl \
    globus-xio \
    globus-xio-gsi-driver \
    globus-xio-popen-driver \
    munge-libs \
    python36-chardet \
    python36-idna \
    python36-pysocks \
    python36-requests \
    python36-six \
    python36-urllib3 \
    scitokens-cpp \
    voms"

externals="$el7externals"

mkdir externals
yumdownloader --downloadonly --destdir=externals $externals

# Extract external RPMs
for file in externals/*.rpm; do
    echo ======= $file =======
    echo $file >> tarball/Manifest.txt
    rpm2cpio $file | (cd tarball; cpio -imd)
done

rm -rf externals
$cmd_dir/make-tarball-links tarball
$cmd_dir/set-tarball-rpath tarball

# Fixup directory permissions for the tarball
chmod 755 tarball/etc/condor/passwords.d
chmod 755 tarball/etc/condor/tokens.d
chmod 755 tarball/var/lib/condor/execute
chmod 755 tarball/var/lib/condor/oauth_credentials
chmod g-s tarball/var/lib/condor/oauth_credentials

# Package final tarball
mv tarball condor-$version-$release.$arch_dist-stripped
tar --create --gzip --owner=0 --group=0 --numeric-owner --file=condor-$version-$release.$arch_dist-stripped.tar.gz condor-$version-$release.$arch_dist-stripped
rm -rf condor-$version-$release.$arch_dist-stripped

ls -lh condor*.tar.gz
exit 0
