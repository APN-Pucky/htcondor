#!/bin/bash

if [ "$1" = "" -o "$2" = "" ] ; then
  echo "Usage:" `basename $0` "<library tarball> <release directory>"
  exit 1
fi
if [ ! -f $1 ] ; then
  echo "$1 isn't a regular file!"
  exit 1
fi
if [ ! -d $2 ] ; then
  echo "$2 isn't a directory!"
  exit 1
fi

tarball=`echo $1 | sed 's|^\([^/]\)|'$PWD'/\1|'`
release_dir=`echo $2 | sed 's|^\([^/]\)|'$PWD'/\1|'`

oldlibs=""
libs=`find $release_dir -path '*/lib/condor/[^/]*' -prune -o -perm -u=x -type f -exec ldd '{}' ';' | \
  grep 'not found' | sed 's/[ ]*\([^ ]*\).*/\1/' | sort -u | grep -v libvirt`
while [ "$libs" != "" -a "$libs" != "$oldlibs" ] ; do
  mkdir -p $release_dir/lib/condor
  cd $release_dir/lib/condor
  tar zxvf $tarball $libs
  oldlibs="$libs"
  libs=`find $release_dir -perm -u=x -type f -exec ldd '{}' ';' | \
    grep 'not found' | sed 's/[ ]*\([^ ]*\).*/\1/' | sort -u | grep -v libvirt`
done
