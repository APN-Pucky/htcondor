#!/usr/bin/env perl

######################################################################
# $Id: remote_post,v 1.1.4.2 2005-06-02 22:56:36 jfrey Exp $
# post script to cleanup after a Condor build, successful or not
######################################################################

# autoflush our STDOUT
$| = 1;


# This is debugging output for the sake of the NWO infrastructure.
# However, it might be useful to us some day so we can see what's
# going on in case of failures...
if( defined $ENV{_NMI_STEP_FAILED} ) { 
    my $nmi_task_failure = "$ENV{_NMI_STEP_FAILED}";
    print "The value of _NMI_STEP_FAILED is: '$nmi_task_failure'\n";

    if ($nmi_task_failure eq "remote_pre"){  
      # Tar up anything we might need for debugging if the remote_pre
      # step fails.
      print "Tarring up debugging info\n";
      system( "tar zcvf results.tar.gz src/config.log" );
      if( $? >> 8 ) {
        print "Can't tar zcvf results.tar.gz src/config.log\n";
        exit 1;
      }
      exit 0;
    }
} else {
    print "The _NMI_STEP_FAILED variable is not set\n";
}


######################################################################
# tar up test results
######################################################################

print "Tarring up results\n";
open( TAR, "tar zcvf results.tar.gz public|" ) || 
    die "Can't open tar as a pipe: $!\n";
while( <TAR> ) { 
    print;
}
close( TAR );
$tarstatus = $? >> 8;
if( $tarstatus ) {
    die "Can't tar zcf results.tar.gz public: status $tarstatus\n";
}
print "Done tarring results\n";
exit 0;
