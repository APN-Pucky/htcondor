#!/usr/bin/env perl

######################################################################
# $Id: platform_post,v 1.1.2.7 2005-07-11 21:28:08 wright Exp $
# post script to cleanup platform-specific files on the submit side
######################################################################

# we just want to chmod everything in the local directory (the
# per-platform directory on the submit side, after everything was
# transfered back) to be world-readable so that other folks can see
# the results.  until Condor's file transfer mechanism preserves
# permissions, we'll have to use this hack. :(

system("chmod a+r *");

# until we do a big day of reckoning for condor_tests and win32, we
# know all the current test infrastructure will fail on that
# platform.  so, for now, just exit success without submitting a test
# job on win32...
if ($ENV{NMI_PLATFORM} eq "x86_winnt_5.1") {
    print "NOT submitting tests for windows\n";
    exit 0;
}


my $tag = $ENV{NMI_tag};
my $module = $ENV{NMI_module};
print "From the environment: tag = $tag\n";
print "From the environment: module = $module\n";
my $runid = `nmi_gid2runid $ENV{_NMI_GID}`;
chomp $runid;

if ( $tag and $module and $runid ) {
    print "This is without using the test_ids file\n";
    print "Submitting test job for platform $ENV{NMI_PLATFORM} ...\n";
    system( "nmi_glue/test_submit/condor_test_submit.pl " .
            "--buildid=$runid --platform=$ENV{NMI_PLATFORM} " .
            "--tag=$tag --module=$module" );
    my $status = $?;
    if( $status ) {
        die "condor_test_submit.pl failed with status $status\n";
    }
}
elsif ( -f "test_ids" ) {
    print "Submitting test job for platform $ENV{NMI_PLATFORM} ...\n";
    system( "nmi_glue/test_submit/condor_test_submit.pl ".
            "--nightly --platform=$ENV{NMI_PLATFORM}" );
    my $status = $?;
    if( $status ) {
        die "condor_test_submit.pl failed with status $status\n";
    }
}
else {
    print "It seems no test_ids file was created. Not submitting a test run\n";
}

